#############################
# for all configuration
#############################

#############################
# common configuration
#############################
server {
    listen 16688 default;
    server_name localhost;
    include      set_var.conf;
    
    location / {
        expires_ext 30d;
        proxy_intercept_errors on;
        error_page 302 = @intercept_302;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        set $srchost $lersrc_decode;
        set $trim_args $args;

        if ($trim_args ~* ^.*nkey2=.*?&(.*)?$) {
            set $trim_args $1;
        }

        if ($trim_args ~* (.*)&errc=.*$) {
            set $trim_args $1;
        }

        if ($trim_args ~* ^errc=.*$) {
            set $trim_args "";
        }

        if ($arg_sthost != "") {
            set $srchost $sthost_decode;
        }

        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Host $srchost;
        proxy_set_header Stat-Type "";
        proxy_set_header X-From-Cdn LECloud;
        proxy_pass http://$lersrc_decode$uri$is_args$trim_args;
    }


    location ~^/coopcdn/cdn.vod.dayoo.com/.*\.m3u8 {
        expires 30d;
        proxy_intercept_errors on;
        error_page 302 = @intercept_302;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;


        set $srchost $lersrc_decode;

        if ($arg_sthost != "") {
            set $srchost $sthost_decode;
        }

        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Host $srchost;
        proxy_set_header Stat-Type "";
        proxy_set_header X-From-Cdn LECloud;
        proxy_pass http://$lersrc_decode$uri$is_args$args;
    }

    location ~ /.*\.m3u8 {
        expires 0;
        proxy_intercept_errors on;
        error_page 302 = @intercept_302;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;


        set $srchost $lersrc_decode;

        if ($arg_sthost != "") {
            set $srchost $sthost_decode;
        }

        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Host $srchost;
        proxy_set_header Stat-Type "";
        proxy_set_header X-From-Cdn LECloud;
        proxy_pass http://$lersrc_decode$uri$is_args$args;
    }       

    location @intercept_302 {
        expires_ext 30d;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        set $location_addr $upstream_http_location;

        if ($upstream_http_location = "") {
            add_header Powered-By-LetvNgx 404;
            return 404;
        }
        proxy_pass $location_addr;
    }

}

#############################
# live.ltcloud.1905.com configuration
#############################
server {
    listen 16688;
    server_name live.ltcloud.1905.com;
    include      set_var.conf;

    location ~* m3u8 {
        expires 0;
        proxy_intercept_errors on;
        error_page 302 = @intercept_302;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        set $srchost $lersrc_decode;

        if ($arg_sthost != "") {
            set $srchost $sthost_decode;
        }

        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Host $srchost;
        proxy_set_header Stat-Type "";
        proxy_set_header X-From-Cdn LECloud;
        proxy_pass http://$lersrc_decode$uri$is_args$trim_args;
    }

    location ~ \.ts {
        expires 1h;
        proxy_intercept_errors on;
        error_page 302 = @intercept_302;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        set $srchost $lersrc_decode;

        if ($arg_sthost != "") {
            set $srchost $sthost_decode;
        }

        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Host $srchost;
        proxy_set_header Stat-Type "";
        proxy_set_header X-From-Cdn LECloud;
        proxy_pass http://$lersrc_decode$uri$is_args$trim_args;
    }

    location @intercept_302 {
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        set $location_addr $upstream_http_location;

        if ($uri  ~ "\.ts") {
            expires 365d;
        }

        if ($uri ~ "m3u8") {
            expires 1d;
        }

        if ($uri ~ "testspeed/nocache.ts") {
            expires 0;
        }

        if ($upstream_http_location = "") {
            add_header Powered-By-LetvNgx 404;
            return 404;
        }
        proxy_pass $location_addr;
    }
}

#############################
# hd.ws.hls.ott.cibntv.net configuration
#############################
server {
    listen 16688;
    server_name hd.ws.hls.ott.cibntv.net;
    include      set_var.conf;

    location ~* m3u8 {
	expires 1d;	
        proxy_intercept_errors on;
        error_page 302 = @intercept_302;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        set $srchost $lersrc_decode;

        if ($arg_sthost != "") {
            set $srchost $sthost_decode;
        }

        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Host $srchost;
        proxy_set_header Stat-Type "";
        proxy_set_header X-From-Cdn LECloud;
	proxy_pass http://$lersrc_decode$uri$is_args$trim_args;
    }

    location ~* testspeed/nocache.ts {
	expires 0;
	proxy_intercept_errors on;
        error_page 302 = @intercept_302;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        set $srchost $lersrc_decode;

        if ($arg_sthost != "") {
            set $srchost $sthost_decode;
        }

        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Host $srchost;
        proxy_set_header Stat-Type "";
        proxy_set_header X-From-Cdn LECloud;
	proxy_pass http://$lersrc_decode$uri$is_args$trim_args;
    }

    location ~ \.ts {
        expires 365d;
        proxy_intercept_errors on;
        error_page 302 = @intercept_302;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        set $srchost $lersrc_decode;

        if ($arg_sthost != "") {
            set $srchost $sthost_decode;
        }

        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Host $srchost;
        proxy_set_header Stat-Type "";
        proxy_set_header X-From-Cdn LECloud;
	proxy_pass http://$lersrc_decode$uri$is_args$trim_args;
    }	

    location \ {
        proxy_intercept_errors on;
        error_page 302 = @intercept_302;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        set $srchost $lersrc_decode;

        if ($arg_sthost != "") {
            set $srchost $sthost_decode;
        }

        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Host $srchost;
        proxy_set_header Stat-Type "";
        proxy_set_header X-From-Cdn LECloud;
	proxy_pass http://$lersrc_decode$uri$is_args$trim_args;
    }

    location @intercept_302 {
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        set $location_addr $upstream_http_location;

        if ($uri  ~ "\.ts") {
            expires 365d;
        }

        if ($uri ~ "m3u8") {
            expires 1d;
        }

        if ($uri ~ "testspeed/nocache.ts") {
            expires 0;
        }

        if ($upstream_http_location = "") {
            add_header Powered-By-LetvNgx 404;
            return 404;
        }
        proxy_pass $location_addr;
    }
}

#############################
#sohu configuration
#############################
server {
    listen 16688;
    server_name sohutv.gslb.coop.lecloud.com;
    include      set_var.conf;

    location / {
        proxy_intercept_errors on;
        error_page 302 = @intercept_302;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        set $srchost $lersrc_decode;

        if ($arg_sthost != "") {
            set $srchost $sthost_decode;
        }

        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Host $srchost;
        proxy_set_header Stat-Type "";
        proxy_set_header X-From-Cdn LECloud;
        proxy_pass http://$lersrc_decode/rip?path=$uri&rip=letv;
    }

    location @intercept_302 {
        expires_ext 30d;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        set $location_addr $upstream_http_location;

        if ($upstream_http_location = "") {
            add_header Powered-By-LetvNgx 404;
            return 404;
        }
        proxy_pass $location_addr;
    }
}

#############################
#icntv configuration
#############################
server {
    listen 16688;
    server_name lecloudoverseasxg.icntvcdn.com overseatest.icntvcdn.com;
    include      set_var.conf;

    location / {
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        set $srchost $lersrc_decode;

        if ($arg_sthost != "") {
            set $srchost $sthost_decode;
        }

        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Host $srchost;
        proxy_set_header Stat-Type "";
        proxy_set_header X-From-Cdn LECloud;
        proxy_pass http://$lersrc_decode$uri;
    }

    location ~ .*\.ts {
        expires 1h;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        set $srchost $lersrc_decode;

        if ($arg_sthost != "") {
            set $srchost $sthost_decode;
        }

        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Host $srchost;
        proxy_set_header Stat-Type "";
        proxy_set_header X-From-Cdn LECloud;
        proxy_pass http://$lersrc_decode$uri;
    }

    location ~ .*\.m3u8 {
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        set $srchost $lersrc_decode;

        if ($arg_sthost != "") {
            set $srchost $sthost_decode;
        }

	subs_filter_types */* text/plain;
        subs_filter .*/(.*/.*/.*/.*\.ts).* $1 ir; 

        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Host $srchost;
        proxy_set_header Stat-Type "";
        proxy_set_header X-From-Cdn LECloud;
	proxy_hide_header Content-Range;
        proxy_pass http://$lersrc_decode$uri;
    }
}

#############################
#und configuration
#############################
server {
    listen 16688;
    server_name *.gole.tv;
    include      set_var.conf;

    location / {
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        set $srchost $lersrc_decode;

        if ($arg_sthost != "") {
            set $srchost $sthost_decode;
        }

        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Host $srchost;
        proxy_set_header Stat-Type "";
        proxy_set_header X-From-Cdn LECloud;
        proxy_pass http://$lersrc_decode$uri$is_args$args;
    }

    location ~ .*\.ts {
        expires 8s;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        set $srchost $lersrc_decode;

        if ($arg_sthost != "") {
            set $srchost $sthost_decode;
        }

        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Host $srchost;
        proxy_set_header Stat-Type "";
        proxy_set_header X-From-Cdn LECloud;
        proxy_pass http://$lersrc_decode$uri$is_args$args;
    }

    location ~ .*\.m3u8 {
        expires 3s;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        set $srchost $lersrc_decode;

        if ($arg_sthost != "") {
            set $srchost $sthost_decode;
        }

        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Host $srchost;
        proxy_set_header Stat-Type "";
        proxy_set_header X-From-Cdn LECloud;
        proxy_pass http://$lersrc_decode$uri$is_args$args;
   }
}

#############################
#verycloud configuration
#############################
server {
    listen 16688;
    server_name xinying-hls.verycloud.cn;
    include      set_var.conf;

    location / {
	expires 30;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        set $srchost $lersrc_decode;

        if ($arg_sthost != "") {
            set $srchost $sthost_decode;
        }

        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Host $srchost;
        proxy_set_header Stat-Type "";
        proxy_set_header X-From-Cdn LECloud;
        proxy_pass http://$lersrc_decode$uri;
    }

    location ~ /.*\.m3u8 {
        expires 0;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;


        set $srchost $lersrc_decode;

        if ($arg_sthost != "") {
            set $srchost $sthost_decode;
        }

        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Host $srchost;
        proxy_set_header Stat-Type "";
        proxy_set_header X-From-Cdn LECloud;
        proxy_pass http://$lersrc_decode$uri;
    }
}

#############################
#wdjcdn configuration
#############################
server {
    listen 16688;
    server_name   st.wdjcdn.com;
    include      set_var.conf;

    location ~ .*\.apk {
        expires 30d;
        proxy_intercept_errors on;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

	set $max_age "must-revalidate,no-cache,no-store";
        if ($host = "le-apk.wdjcdn.com") {
            set $max_age "max-age=120";
        }
        more_set_headers -s 404 'Cache-Control: $max_age'; 

        set $srchost $lersrc_decode;
        set $trim_args $args;

        if ($trim_args ~* ^.*nkey2=.*?&(.*)?$) {
            set $trim_args $1;
        }

        if ($trim_args ~* (.*)&errc=.*$) {
            set $trim_args $1;
        }

        if ($trim_args ~* ^errc=.*$) {
            set $trim_args "";
        }

        if ($arg_sthost != "") {
            set $srchost $sthost_decode;
        }

        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Host $srchost;
        proxy_set_header Stat-Type "";
        proxy_set_header X-From-Cdn LECloud;
        proxy_pass http://$lersrc_decode$uri$is_args$trim_args;
    }

    location / {
        proxy_intercept_errors on;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        set $srchost $lersrc_decode;
        set $trim_args $args;

        if ($trim_args ~* ^.*nkey2=.*?&(.*)?$) {
            set $trim_args $1;
        }

        if ($trim_args ~* (.*)&errc=.*$) {
            set $trim_args $1;
        }

        if ($trim_args ~* ^errc=.*$) {
            set $trim_args "";
        }

        if ($arg_sthost != "") {
            set $srchost $sthost_decode;
        }

        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Host $srchost;
        proxy_set_header Stat-Type "";
        proxy_set_header X-From-Cdn LECloud;
        proxy_pass http://$lersrc_decode$uri$is_args$trim_args;
    }

}


#############################
#tvesou configuration
#############################
server {
    listen 16688;
    server_name   lelive1.tvesou.com lelive1.nagezan.com;
    include      set_var.conf;

    location ~ /.*\.m3u8 {
        expires 0;
        proxy_intercept_errors on;
        error_page 302 = @intercept_302;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        set $srchost $lersrc_decode;

        if ($arg_sthost != "") {
            set $srchost $sthost_decode;
        }

        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Host $srchost;
        proxy_set_header Stat-Type "";
        proxy_set_header X-From-Cdn LECloud;
        proxy_pass http://$lersrc_decode$uri$is_args$args;
    }

    location ~* /.*\.ts {
        expires 300s;
        proxy_intercept_errors on;
        error_page 302 = @intercept_302;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        set $srchost $lersrc_decode;

        if ($arg_sthost != "") {
            set $srchost $sthost_decode;
        }

        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Host $srchost;
        proxy_set_header Stat-Type "";
        proxy_set_header X-From-Cdn LECloud;
        proxy_pass http://$lersrc_decode$uri$is_args$trim_args;
    }

    location / {
        proxy_intercept_errors on;
        error_page 302 = @intercept_302;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;
        expires_ext 30d;

        set $srchost $lersrc_decode;

        if ($arg_sthost != "") {
            set $srchost $sthost_decode;
        }

        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Host $srchost;
        proxy_set_header Stat-Type "";
        proxy_set_header X-From-Cdn LECloud;
        proxy_pass http://$lersrc_decode$uri$is_args$trim_args;
    }

    location @intercept_302 {
        expires_ext 30d;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        set $location_addr $upstream_http_location;

        if ($upstream_http_location = "") {
            add_header Powered-By-LetvNgx 404;
            return 404;
        }
        proxy_pass $location_addr;
    }

}



#############################
#cutv configuration
server {
    listen 16688;
    server_name tsl2.hls.cutv.com tsl3.hls.cutv.com;
    include      set_var.conf;

    location ~ /.*\.m3u8 {
        expires 0;
        proxy_intercept_errors on;
        error_page 302 = @intercept_302;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;


        set $srchost $lersrc_decode;

        if ($arg_sthost != "") {
            set $srchost $sthost_decode;
        }

        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Host $srchost;
        proxy_set_header Stat-Type "";
        proxy_set_header X-From-Cdn LECloud;
        proxy_pass http://$lersrc_decode$uri$is_args$args;
    }

    location ~* /.*\.ts {
        expires 600s;
        proxy_intercept_errors on;
        error_page 302 = @intercept_302;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;


	set $srchost $lersrc_decode;

        if ($arg_sthost != "") {
            set $srchost $sthost_decode;
        }

        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Host $srchost;
        proxy_set_header Stat-Type "";
        proxy_set_header X-From-Cdn LECloud;
        proxy_pass http://$lersrc_decode$uri;
    }

    location ~* /cutvlive/ {
        expires 30d;
        proxy_intercept_errors on;
        error_page 302 = @intercept_302;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Host $srchost;
        proxy_set_header Stat-Type "";
        proxy_set_header X-From-Cdn LECloud;
        proxy_pass http://$lersrc_decode$uri$is_args$trim_args;
    }

    location @intercept_302 {
        expires_ext 30d;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        set $location_addr $upstream_http_location;

        if ($upstream_http_location = "") {
            add_header Powered-By-LetvNgx 404;
            return 404;
        }
        proxy_pass $location_addr;
    }

}

#############################
# cibntv configuration 
#############################
server {
    listen 16688;
    server_name cibntv.gslb.letv.com letv.hls.ott.cibntv.net;
    include      set_var.conf;

    location / {
        expires_ext 30d;
        proxy_intercept_errors on;
        error_page 302 = @intercept_302;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Host $lersrc_decode;
        proxy_set_header Stat-Type "";
        proxy_pass http://$lersrc_decode$uri$is_args$args;
    }   

    # This location is privisonal for cibntv test
    # and it will be removed at the end of the tesing.
    location ~ ^/.*\.m3u8$ {
        proxy_intercept_errors on;
        error_page 302 = @cibntv_302;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        set $replace_host "ls.hls.ott.cibntv.net";
        
        if ($uri ~* "^/coopcdn/(.*?)/.*$") {
            set $replace_host $1;
        }
        
        sub_filter_types */*;
        sub_filter "hls01.ott.disp.cibntv.net" $replace_host;
        sub_filter_once off;
    
        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Host $lersrc_decode;
        proxy_set_header Stat-Type "";
        proxy_pass http://$lersrc_decode$uri$is_args$args;
    }

    location @intercept_302 {
        expires_ext 30d;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        set $location_addr $upstream_http_location;
    
        if ($upstream_http_location = "") {
            add_header Powered-By-LetvNgx 404;
            return 404;
        }
        proxy_pass $location_addr;
    }

    location @cibntv_302 {
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        sub_filter_types */*;
        sub_filter "hls01.ott.disp.cibntv.net" $replace_host;
        sub_filter_once off;

        set $location_addr $upstream_http_location;

        if ($upstream_http_location = "") {
            add_header Powered-By-LetvNgx 404;
            return 404;
        }
        proxy_pass $location_addr;
    }
}

#############################
# cutv tsl1 configuration 
#############################
server {
    listen 16688;
    server_name tsl1.hls.cutv.com; 
    include      set_var.conf;

    location / {
        expires_ext 30d;
        proxy_intercept_errors on;
        error_page 302 = @intercept_302;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;
        default_type video/MP2T;
        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Host $lersrc_decode;
        proxy_set_header Stat-Type "";
        proxy_pass http://$lersrc_decode$uri$is_args$args;
    }   

    location ~ ^/.*\.m3u8$ {
        proxy_intercept_errors on;
        error_page 302 = @cutv_302;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        set $replace_host "tsl1.hls.cutv.com/";
        set $replace_schema "http://"; 
        
        if ($uri ~* "^/coopcdn/(.*?/).*$") {
            set $replace_host $1;
        }

        set $dst_args "path=$arg_origin_path&proxy=$arg_proxy&lersrc=$arg_lersrc&tag=$arg_tag&platid=$arg_platid";
        subs_filter_types */* application/vnd.apple.mpegurl;
        #subs_filter (.*\.ts$) /coopcdn/$replace_host$1?$dst_args ir;
        #subs_filter (.*\.ts) $1?$dst_args ir; 
        subs_filter (.*\.ts) $1 ir; 
        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Host $lersrc_decode;
        proxy_set_header Stat-Type "";
        proxy_pass http://$lersrc_decode$uri$is_args$args;
    }

    location @intercept_302 {
        expires_ext 30d;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        set $location_addr $upstream_http_location;
    
        if ($upstream_http_location = "") {
            add_header Powered-By-LetvNgx 404;
            return 404;
        }
        proxy_pass $location_addr;
    }

    location @cutv_302 {
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        set $dst_args "path=$arg_origin_path&proxy=$arg_proxy&lersrc=$arg_lersrc&tag=$arg_tag&platid=$arg_platid";
        subs_filter_types */* application/vnd.apple.mpegurl;
        subs_filter (.*\.ts) $1?$dst_args ir;
        set $location_addr $upstream_http_location;

        if ($upstream_http_location = "") {
            add_header Powered-By-LetvNgx 404;
            return 404;
        }
        proxy_pass $location_addr;
    }
}


#############################
# cutv cibn configuration 
#############################
server {
    listen 16688;
    server_name cibn.hls.cutv.com;
    include      set_var.conf;

    location / {
        expires_ext 30d;
        proxy_intercept_errors on;
        error_page 302 = @intercept_302;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Host $lersrc_decode;
        proxy_set_header Stat-Type "";
        proxy_pass http://$lersrc_decode$uri$is_args$args;
    }   

    location ~ ^/.*\.m3u8$ {
        proxy_intercept_errors on;
        error_page 302 = @cutv_302;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        set $replace_host "cibn.hls.cutv.com";
        if ($uri ~* "^/coopcdn/(.*?)/.*$") {
            set $replace_host $1;
        }

	set $dst_args "path=$arg_origin_path&proxy=$arg_proxy&lersrc=$arg_lersrc&tag=$arg_tag&platid=$arg_platid";
	subs_filter_types */* application/x-mpegURL;
	subs_filter (.*\.ts$) /coopcdn/$replace_host$1?$dst_args ir;

        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Host $lersrc_decode;
        proxy_set_header Stat-Type "";
        proxy_pass http://$lersrc_decode$uri$is_args$args;
    }

    location @intercept_302 {
        expires_ext 30d;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        set $location_addr $upstream_http_location;
    
        if ($upstream_http_location = "") {
            add_header Powered-By-LetvNgx 404;
            return 404;
        }
        proxy_pass $location_addr;
    }

    location @cutv_302 {
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

	subs_filter_types */* application/x-mpegURL;
	subs_filter (.*\.ts$) /coopcdn/$replace_host$1?$dst_args ir;

        set $location_addr $upstream_http_location;

        if ($upstream_http_location = "") {
            add_header Powered-By-LetvNgx 404;
            return 404;
        }
        proxy_pass $location_addr;
    }
}


#############################
# cutv yao configuration 
#############################
server {
    listen 16688;
    server_name yao.hls.cutv.com;
    include      set_var.conf;

    location / {
        expires_ext 30d;
        proxy_intercept_errors on;
        error_page 302 = @intercept_302;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Host $lersrc_decode;
        proxy_set_header Stat-Type "";
        proxy_pass http://$lersrc_decode$uri$is_args$args;
    }   

    location ~ ^/.*\.m3u8$ {
        proxy_intercept_errors on;
        error_page 302 = @cutv_302;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;
        proxy_set_header Accept-Encoding "";

        set $replace_host "yao.hls.cutv.com";
        if ($uri ~* "^/coopcdn/(.*?)/.*$") {
            set $replace_host $1;
        }

        set $dst_args "path=$arg_origin_path&proxy=$arg_proxy&lersrc=$arg_lersrc&tag=$arg_tag&platid=$arg_platid";
        subs_filter_types */* application/vnd.apple.mpegurl;
        #subs_filter (.*\.ts$) /coopcdn/$replace_host$1?$dst_args ir;
        subs_filter \.\./\.\./\.\.(.*\.ts) /coopcdn/$replace_host$1?$dst_args ir;
        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Host $lersrc_decode;
        proxy_set_header Stat-Type "";
        proxy_pass http://$lersrc_decode$uri$is_args$args;
    }
}



#############################
# letv cloud configuration 
#############################
server {
    listen 16688;
    server_name cloud.gslb.letv.com;

    location / {
        expires_ext 30d;
        proxy_intercept_errors on;
        error_page 302 = @intercept_302;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

	set $trim_args $args;

        if ($args ~* "(.*)&rstart=.*?(&.*)?$") {
            set $trim_args $1$2;
        }

        if ($trim_args ~* "(.*)&rend=.*?(&.*)?$") {
            set $trim_args $1$2;
        }
    
        set $cloud_src "cloud.letv.com";
  
        if ($arg_fsrc != "") {
            set $cloud_src $arg_fsrc;
        }
        
        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Stat-Type "";
        proxy_pass http://$cloud_src/uss$uri$is_args$trim_args;
    }   

    location @intercept_302 {
        expires_ext 30d;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        set $location_addr $upstream_http_location;
    
        if ($upstream_http_location = "") {
            add_header Powered-By-LetvNgx 404;
            return 404;
        }
        proxy_pass $location_addr;
    }
}

#############################
# tvmining configuration 
#############################
server {
    listen 16688;
    server_name stream.suntv.tvmining.com stream.ottcdn.cibntvm.com live01.ott.cibntv.net suntv.letvcdn.tvmining.com mtq.letvcdn.tvmcloud.com;
    include      set_var.conf;

    # ts
    location / {
        expires_ext 7d;
        proxy_intercept_errors on;
        error_page 302 = @intercept_302;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Host $lersrc_decode;
        proxy_set_header Stat-Type "";
	proxy_set_header X-REAL-IP $http_x_ip;
	proxy_set_header X-IP "";
	proxy_set_header Client-ip "";
	proxy_set_header X-Forwarded-For "";
        proxy_pass http://$lersrc_decode$uri$is_args$args;
    }   

    # live m3u8 
    location ~ ^.*/approve/live$ {
        proxy_hide_header Expires;
        proxy_intercept_errors on;
        error_page 302 = @tvmining_302;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

	set $tvmining_replace_host "live01.ott.cibntv.net";

	if ($uri ~* "^/coopcdn/(.*?)/.*$") {
	    set $tvmining_replace_host $1;
        }

	sub_filter_types */* application/x-mpegURL;
	sub_filter "../cache/" "http://${tvmining_replace_host}/cache/";
	sub_filter_once off;

        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;
        proxy_set_header Host $lersrc_decode;
        proxy_set_header Stat-Type "";
	proxy_set_header X-REAL-IP $http_x_ip;
	proxy_set_header X-IP "";
	proxy_set_header Client-ip "";
	proxy_set_header X-Forwarded-For "";
        proxy_pass http://$lersrc_decode$uri$is_args$args;
    }   

    # replay m3u8 
    location ~ ^.*/approve/vod$ {
        proxy_intercept_errors on;
        error_page 302 = @tvmining_302;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

	set $tvmining_replace_host "live01.ott.cibntv.net";

	if ($uri ~* "^/coopcdn/(.*?)/.*$") {
	    set $tvmining_replace_host $1;
        }

	sub_filter_types */* application/x-mpegURL;
	sub_filter "../cache/" "http://${tvmining_replace_host}/cache/";
	sub_filter_once off;

        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Host $lersrc_decode;
        proxy_set_header Stat-Type "";
	proxy_set_header X-REAL-IP $http_x_ip;
	proxy_set_header X-IP "";
	proxy_set_header Client-ip "";
	proxy_set_header X-Forwarded-For "";
        proxy_pass http://$lersrc_decode$uri$is_args$args;
    }   

    location @intercept_302 {
        expires_ext 30d;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        set $location_addr $upstream_http_location;
    
        if ($upstream_http_location = "") {
            add_header Powered-By-LetvNgx 404;
            return 404;
        }
        proxy_pass $location_addr;
    }

    location @tvmining_302 {
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

	sub_filter_types */* application/x-mpegURL;
	sub_filter "../cache/" "http://${tvmining_replace_host}/cache";
	sub_filter_once off;

        set $location_addr $upstream_http_location;

        if ($upstream_http_location = "") {
            add_header Powered-By-LetvNgx 404;
            return 404;
        }
        proxy_pass $location_addr;
    }
}

#############################
# qihu360-zjw configuration
#############################
server {
    listen 16688;
    server_name media.360.umanmi.com;
    include      set_var.conf;
    
    location / {
        expires_ext 30d;
        proxy_intercept_errors on;
        error_page 302 = @intercept_302;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

	set $user_host $lersrc_decode;
        if ($uri ~* "^/coopcdn/(.*?)/.*$") {
	    set $user_host $1;
	}

        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Host $user_host;
        proxy_set_header Stat-Type "";
        proxy_pass http://$lersrc_decode$uri$is_args$args;
    }       

    location @intercept_302 {
        expires_ext 30d;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        set $location_addr $upstream_http_location;

        if ($upstream_http_location = "") {
            add_header Powered-By-LetvNgx 404;
            return 404;
        }
        proxy_pass $location_addr;
    }
}

# sina configuration 
#############################
server {
    listen 16688;
    server_name sina.live.lecloud.com;
    include      set_var.conf;

    location / {
        expires_ext 30d;
        proxy_intercept_errors on;
        error_page 302 = @intercept_302;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Host $lersrc_decode;
        proxy_set_header Stat-Type "";
        proxy_pass http://$lersrc_decode$uri$is_args$args;
    }   

    location ~ ^/.*\.m3u8$ {
        proxy_intercept_errors on;
        error_page 302 = @sina_302;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

	set $dst_args "path=$arg_origin_path&proxy=$arg_proxy&lersrc=$arg_lersrc&tag=$arg_tag&platid=$arg_platid";
        subs_filter_types */* application/vnd.apple.mpegurl;
	subs_filter /(.*\.ts$) /coopcdn/sina.live.lecloud.com/$1?$dst_args ir;
    
        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Host $lersrc_decode;
        proxy_set_header Stat-Type "";
        proxy_pass http://$lersrc_decode$uri$is_args$args;
    }

    location @intercept_302 {
        expires_ext 30d;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        set $location_addr $upstream_http_location;
    
        if ($upstream_http_location = "") {
            add_header Powered-By-LetvNgx 404;
            return 404;
        }
        proxy_pass $location_addr;
    }

    location @sina_302 {
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        subs_filter_types */* application/vnd.apple.mpegurl;
	subs_filter /(.*\.ts$) /coopcdn/sina.live.lecloud.com/$1?$dst_args ir;

        set $location_addr $upstream_http_location;

        if ($upstream_http_location = "") {
            add_header Powered-By-LetvNgx 404;
            return 404;
        }
        proxy_pass $location_addr;
    }
}

#############################
# yunfeidu configuration
#############################
server {
    listen 16688;
    server_name mnj.le.ivmall.com;
    include      set_var.conf;
    
    location / {
	expires 30d;
        proxy_intercept_errors on;
        error_page 302 = @intercept_302;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Host $lersrc_decode;
        proxy_set_header Stat-Type "";
        proxy_pass http://$lersrc_decode$uri;
    }       

    location ~ ^/.*\.m3u8$ {
	expires 1d;
        proxy_intercept_errors on;
        error_page 302 = @intercept_302;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

	set $dst_args "path=$arg_origin_path&proxy=$arg_proxy&lersrc=$arg_lersrc&tag=$arg_tag&platid=$arg_platid";
        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;
        subs_filter_types */* application/vnd.apple.mpegurl;
	subs_filter (^.*(\.m3u8|\.ts)$)  $1?$dst_args ir;

        proxy_set_header Host $lersrc_decode;
        proxy_set_header Stat-Type "";
        proxy_pass http://$lersrc_decode$uri;
    }

    location @intercept_302 {
        expires_ext 30d;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        set $location_addr $upstream_http_location;

        if ($upstream_http_location = "") {
            add_header Powered-By-LetvNgx 404;
            return 404;
        }
        proxy_pass $location_addr;
    }
}


server {
    listen 16688;
    server_name lehls01.vhall.com;
    include      set_var.conf;

    location / {
        expires 2h;
        proxy_intercept_errors on;
        error_page 302 = @intercept_302;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Host $lersrc_decode;
        proxy_set_header Stat-Type "";
        proxy_pass http://$lersrc_decode$uri;
    }

    location ~ ^/.*\.m3u8$ {
        proxy_intercept_errors on;
        error_page 302 = @intercept_302;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        set $dst_args "path=$arg_origin_path&proxy=$arg_proxy&lersrc=$arg_lersrc&tag=$arg_tag&platid=$arg_platid";
        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        #subs_filter_types */* application/x-mpegURL;
        #subs_filter /(.*\.ts$) /coopcdn/lehls01.vhall.com/$1?$dst_args ir;

        proxy_set_header Accept-Encoding "";
        proxy_set_header Host $lersrc_decode;
        proxy_set_header Stat-Type "";

        proxy_pass http://$lersrc_decode$uri;
    }

    location @intercept_302 {
        expires_ext 30d;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        set $location_addr $upstream_http_location;

        if ($upstream_http_location = "") {
            add_header Powered-By-LetvNgx 404;
            return 404;
        }
        proxy_pass $location_addr;
    }
}


#############################
# 51CTO configuration
#############################
server {
    listen 16688;
    server_name v11.51cto.com;
    include      set_var.conf;
    
    location / {
        expires_ext 30d;
        proxy_intercept_errors on;
        error_page 302 = @intercept_302;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        set $replace_host "v11.51cto.com";

        if ($uri ~* "^/coopcdn/(.*?)/.*$") {
            set $replace_host $1;
        }

        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

	proxy_set_header Host $replace_host;
        proxy_set_header Stat-Type "";
        proxy_pass http://$lersrc_decode$uri$is_args$args;
    }       

    location @intercept_302 {
        expires_ext 30d;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        set $location_addr $upstream_http_location;

        if ($upstream_http_location = "") {
            add_header Powered-By-LetvNgx 404;
            return 404;
        }
        proxy_pass $location_addr;
    }

}

###coocaatv

server {
    listen 16688;
    server_name *.coocaatv.com;

    location / {
        proxy_intercept_errors on;
        error_page 302 = @intercept_302;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        if ($uri ~* "mp4|flv") {
            expires 365d;
        }

	rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Host $lersrc_decode;
        proxy_set_header Stat-Type "";
        proxy_pass http://$lersrc_decode$uri;
    }

    location @intercept_302 {
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        if ($location_addr ~* "mp4|flv") {
            expires_ext  365d;
        }

        set $location_addr $upstream_http_location;

        proxy_pass $lersrc_decode$uri;
    }


}

server {
    listen 16688;
    server_name *.sobeycache.com;

    location / {
        expires 2h;
        proxy_intercept_errors on;
        error_page 302 = @intercept_302;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Host $lersrc_decode;
        proxy_set_header Stat-Type "";
        proxy_pass http://$lersrc_decode$uri;
    }

    location ~ ^/.*\.m3u8$ {
        proxy_intercept_errors on;
        error_page 302 = @intercept_302;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;
        proxy_set_header Sobey_Host "Sobey_Host";

        set $dst_args "path=$arg_origin_path&proxy=$arg_proxy&lersrc=$arg_lersrc&tag=$arg_tag&platid=$arg_platid";
        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;
        
        if ($http_sobey_host != "") {
            return 302;
        }

        subs_filter_types */* application/vnd.apple.mpegurl;
        subs_filter (.*\.ts$) $1?$dst_args ir;

        proxy_set_header Accept-Encoding "";
        proxy_set_header Host $lersrc_decode;
        proxy_set_header Stat-Type "";

        proxy_pass http://127.0.0.1:16688;
    }

    location @intercept_302 {
        expires_ext 30d;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        set $location_addr $upstream_http_location;

        proxy_pass $lersrc_decode$uri;
    }
}


server {
    listen 16688;
    server_name *.iqilu.com;
    include      set_var.conf;

    location / {
        expires 1d;
        proxy_intercept_errors on;
        error_page 302 = @intercept_302;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Host $sthost_decode;
        proxy_set_header Stat-Type "";
        proxy_pass http://$lersrc_decode$uri?$args;
    }

    location ~ ^/.*\.m3u8$ {
        proxy_intercept_errors on;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        set $dst_args "path=$arg_origin_path&proxy=$arg_proxy&lersrc=$arg_lersrc&tag=$arg_tag&platid=$arg_platid&sign=$arg_sign&sthost=$arg_sthost";
        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;


        subs_filter_types */* application/vnd.apple.mpegurl;
        subs_filter (.*\.ts$) $1?$dst_args ir;

        proxy_set_header Accept-Encoding "";
        proxy_set_header Host $sthost_decode;
        proxy_set_header Stat-Type "";

        proxy_pass http://$lersrc_decode$uri?$args;
    }
}

server {
   listen 16688;
   server_name *.upuday.com;
   include      set_var.conf;
  
   location / {
        expires 1d;
        proxy_intercept_errors on;
        error_page 302 = @intercept_302;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Host $lersrc_decode;
        proxy_set_header Stat-Type "";
        proxy_pass http://$lersrc_decode$uri;
    }

    location ~ ^/.*\.m3u8$ {
        proxy_intercept_errors on;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        set $dst_args "path=$arg_origin_path&proxy=$arg_proxy&lersrc=$arg_lersrc&tag=$arg_tag&platid=$arg_platid";
        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;


        subs_filter_types */* application/vnd.apple.mpegurl;
        #subs_filter (.*\.ts$) $1?$dst_args ir;

        proxy_set_header Accept-Encoding "";
        proxy_set_header Host $lersrc_decode;
        proxy_set_header Stat-Type "";

        proxy_pass http://$lersrc_decode$uri;
    }
}


server {
   listen 16688;
   server_name *.tvfan.cn;

   location / {
        expires 3m;
        proxy_intercept_errors on;
        error_page 302 = @intercept_302;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Host $lersrc_decode;
        proxy_set_header Stat-Type "";
        proxy_pass http://$lersrc_decode$uri;
    }

    location ~ ^/.*\.m3u8$ {
        proxy_intercept_errors on;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;
        error_page 405 = @RECYCLE;
        set $dst_args "path=$arg_origin_path&proxy=$arg_proxy&lersrc=$arg_lersrc&tag=$arg_tag&platid=$arg_platid&sign=$arg_sign";
        
        if ($http_letv_last = "1") {
            return 405;
        }

        subs_filter_types */* application/vnd.apple.mpegurl;
        subs_filter (.*\.ts$) $1?$dst_args ir;

        proxy_set_header Accept-Encoding "";
        proxy_set_header Stat-Type in;
        proxy_set_header Letv-Last 1;
        proxy_set_header Host $http_host;
        proxy_pass http://127.0.0.1:16688;
    }

    location @RECYCLE {
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;
        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Stat-Type "";
        proxy_set_header Host $lersrc_decode;
        proxy_pass http://$lersrc_decode$uri;
    }
}

server {
   listen 16688;
   server_name padhuodong3.imgo.tv  padhuodong.imgo.tv phonehuodong3.imgo.tv padhuodong3jf.imgo.tv phonehuodong3jf.imgo.tv;

   location / {
        expires 1d;
        proxy_intercept_errors on;
        error_page 302 = @intercept_302;
        proxy_connect_timeout 1s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Host $lersrc_decode;
        proxy_set_header Stat-Type "";
        proxy_pass http://imgo_backend$uri?$args;
    }

    location ~ ^/.*\.m3u8$ {
        expires 3s;
        proxy_intercept_errors on;
        proxy_connect_timeout 1s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;
        set $dst_args "path=$arg_origin_path&proxy=$arg_proxy&lersrc=$arg_lersrc&tag=$arg_tag&platid=$arg_platid&sign=$arg_sign";
        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;


        proxy_set_header Accept-Encoding "";
        proxy_set_header Stat-Type "";
        proxy_set_header Host $lersrc_decode;
        proxy_pass http://imgo_backend$uri?$args;
    }
}

upstream imgo_backend {
    server hlssource.imgo.letv.com:8080 fail_timeout=300s;
    server hlssourcebak.imgo.letv.com:8080 backup fail_timeout=300s;
}


server {
    listen 16688;
    server_name  video.hrbtv.net;
    include      set_var.conf;

    location / {
        expires_ext 30d;
        proxy_intercept_errors on;
        error_page 302 = @intercept_302;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        set $srchost $lersrc_decode;
        set $trim_args $args;

        if ($trim_args ~* ^.*nkey2=.*?&(.*)?$) {
            set $trim_args $1;
        }

        if ($trim_args ~* (.*)&errc=.*$) {
            set $trim_args $1;
        }

        if ($trim_args ~* ^errc=.*$) {
            set $trim_args "";
        }

        if ($arg_sthost != "") {
            set $srchost $sthost_decode;
        }

        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;
        proxy_hide_header Content-Range;
        proxy_set_header Host $srchost;
        proxy_set_header Stat-Type "";
        proxy_set_header X-From-Cdn LECloud;
        proxy_pass http://$lersrc_decode$uri$is_args$trim_args;
    }
}



server {
    listen 16688;
    server_name  *.kukuplay.com;
    include      set_var.conf;

    location / {
        proxy_intercept_errors on;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;
        more_set_headers -s 404 'Cache-Control: max-age=1';

        set $trim_args $args;

        if ($trim_args ~* ^.*nkey2=.*?&(.*)?$) {
            set $trim_args $1;
        }

        if ($trim_args ~* (.*)&errc=.*$) {
            set $trim_args $1;
        }

        if ($trim_args ~* ^errc=.*$) {
            set $trim_args "";
        }

        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Host $http_sthost;
        proxy_set_header Stat-Type "";
        proxy_set_header X-From-Cdn LECloud;
        proxy_pass http://$lersrc_decode$uri$is_args$trim_args;
    }
}

server {
   listen 16688;
   server_name aiseet.lszb.atianqi.com aiseet.lszbtest.atianqi.com aiseet.lszb.snm.atianqi.com wxgd.lszb.atianqi.com wxmm.lszb.atianqi.com wxyj.lszb.atianqi.com;

   location / {
        expires 1d;
        proxy_intercept_errors on;
        error_page 302 = @intercept_302;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Host $lersrc_decode;
        proxy_set_header Stat-Type "";
        proxy_pass http://$lersrc_decode$uri;
    }

    location ~ ^/.*\.m3u8$ {
        proxy_intercept_errors on;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;
        error_page 405 = @RECYCLE;
        expires 6s;
   
        if ($http_letv_last = "1") {
            return 405;
        }

        proxy_set_header Accept-Encoding "";
        proxy_set_header Stat-Type in;
        proxy_set_header Letv-Last 1;
        proxy_set_header Host $http_host;
        proxy_hide_header Content-Type;
        add_header Content-Type application/x-mpegURL;
        proxy_pass http://127.0.0.1:16688$uri?$args;
    }

    location @RECYCLE {
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;
        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Stat-Type "";
        proxy_set_header Host $lersrc_decode;
        proxy_pass http://$lersrc_decode$uri?$args;
    }
}

server {
   listen 16688;
   server_name  wxgd.yd.lsdb.atianqi.com;

   location / {
        expires 1d;
        proxy_intercept_errors on;
        error_page 302 = @intercept_302;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Host $lersrc_decode;
        proxy_set_header Stat-Type "";
        proxy_pass http://$lersrc_decode:8011$uri;
    }

    location ~ ^/.*\.m3u8$ {
        proxy_intercept_errors on;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;
        error_page 405 = @RECYCLE;
        expires 1d;

        if ($http_letv_last = "1") {
            return 405;
        }

        proxy_set_header Accept-Encoding "";
        proxy_set_header Stat-Type in;
        proxy_set_header Letv-Last 1;
        proxy_set_header Host $http_host;
        proxy_pass http://127.0.0.1:16688$uri?$args;
    }

    location @RECYCLE {
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;
        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Stat-Type "";
        proxy_set_header Host $lersrc_decode;
        proxy_pass http://$lersrc_decode:8011$uri?$args;
    }
}

server {
   listen 16688;
   server_name  *.lsdb.atianqi.com;

   location / {
        expires 1d;
        proxy_intercept_errors on;
        error_page 302 = @intercept_302;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Host $lersrc_decode;
        proxy_set_header Stat-Type "";
        proxy_pass http://$lersrc_decode$uri;
    }

    location ~ ^/.*\.m3u8$ {
        proxy_intercept_errors on;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;
        error_page 405 = @RECYCLE;
        expires 1d;

        if ($http_letv_last = "1") {
            return 405;
        }

        proxy_set_header Accept-Encoding "";
        proxy_set_header Stat-Type in;
        proxy_set_header Letv-Last 1;
        proxy_set_header Host $http_host;
        proxy_pass http://127.0.0.1:16688$uri?$args;
    }

    location @RECYCLE {
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;
        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Stat-Type "";
        proxy_set_header Host $lersrc_decode;
        proxy_pass http://$lersrc_decode$uri?$args;
    }
}

server {
   listen 16688;
   server_name  aiseet.lsdb.atianqi.com aiseet.lshk.atianqi.com aiseet.lsdbtest.atianqi.com aiseet.lsdb.snm.atianqi.com;

   location / {
        expires 1d;
        proxy_intercept_errors on;
        error_page 302 = @intercept_302;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Host $lersrc_decode;
        proxy_set_header Stat-Type "";
        proxy_pass http://$lersrc_decode$uri;
    }

    location ~ ^/.*\.m3u8$ {
        proxy_intercept_errors on;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;
        error_page 405 = @RECYCLE;
        expires 1d;

        if ($http_letv_last = "1") {
            return 405;
        }

        proxy_set_header Accept-Encoding "";
        proxy_set_header Stat-Type in;
        proxy_set_header Letv-Last 1;
        proxy_set_header Host $http_host;
        proxy_pass http://127.0.0.1:16688$uri?$args;
    }

    location @RECYCLE {
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;
        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Stat-Type "";
        proxy_set_header Host $lersrc_decode;
        proxy_pass http://$lersrc_decode$uri?$args;
    }
}

server {
    listen 16688;
    server_name *.lsdb.snm.atianqi.com;
    include      set_var.conf;
    
    location / {
        expires_ext 30d;
        proxy_intercept_errors on;
        error_page 302 = @intercept_302;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        set $srchost $lersrc_decode;
        set $trim_args $args;

        if ($trim_args ~* ^.*nkey2=.*?&(.*)?$) {
            set $trim_args $1;
        }

        if ($trim_args ~* (.*)&errc=.*$) {
            set $trim_args $1;
        }

        if ($trim_args ~* ^errc=.*$) {
            set $trim_args "";
        }

        if ($arg_sthost != "") {
            set $srchost $sthost_decode;
        }

        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Host $srchost;
        proxy_set_header Stat-Type "";
        proxy_set_header X-From-Cdn LECloud;
        proxy_pass http://$lersrc_decode$uri$is_args$trim_args;
    }

    location ~ /.*\.ts {
	    expires 1d;
	    proxy_intercept_errors on;
	    error_page 302 = @intercept_302;
	    proxy_connect_timeout 30s;
	    proxy_send_timeout    45s;
	    proxy_read_timeout    45s;


	    set $srchost $lersrc_decode;

	    if ($arg_sthost != "") {
		    set $srchost $sthost_decode;
	    }

	    rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

	    proxy_set_header Host $srchost;
	    proxy_set_header Stat-Type "";
	    proxy_set_header X-From-Cdn LECloud;
	    proxy_pass http://$lersrc_decode$uri$is_args$args;
    }

    location ~ /.*\.m3u8 {
        expires 1d;
        proxy_intercept_errors on;
        error_page 302 = @intercept_302;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;


        set $srchost $lersrc_decode;

        if ($arg_sthost != "") {
            set $srchost $sthost_decode;
        }

        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Host $srchost;
        proxy_set_header Stat-Type "";
        proxy_set_header X-From-Cdn LECloud;
        proxy_pass http://$lersrc_decode$uri$is_args$args;
    }       

    location @intercept_302 {
        expires_ext 30d;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        set $location_addr $upstream_http_location;

        if ($upstream_http_location = "") {
            add_header Powered-By-LetvNgx 404;
            return 404;
        }
        proxy_pass $location_addr;
    }
}

server {
    listen 16688;
    server_name *.lszb.atianqi.com;
    include      set_var.conf;
    
    location / {
        expires_ext 30d;
        proxy_intercept_errors on;
        error_page 302 = @intercept_302;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        set $srchost $lersrc_decode;
        set $trim_args $args;

        if ($trim_args ~* ^.*nkey2=.*?&(.*)?$) {
            set $trim_args $1;
        }

        if ($trim_args ~* (.*)&errc=.*$) {
            set $trim_args $1;
        }

        if ($trim_args ~* ^errc=.*$) {
            set $trim_args "";
        }

        if ($arg_sthost != "") {
            set $srchost $sthost_decode;
        }

        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Host $srchost;
        proxy_set_header Stat-Type "";
        proxy_set_header X-From-Cdn LECloud;
        proxy_pass http://$lersrc_decode$uri$is_args$trim_args;
    }

    location ~ /.*\.ts {
	    expires 1d;
	    proxy_intercept_errors on;
	    error_page 302 = @intercept_302;
	    proxy_connect_timeout 30s;
	    proxy_send_timeout    45s;
	    proxy_read_timeout    45s;


	    set $srchost $lersrc_decode;

	    if ($arg_sthost != "") {
		    set $srchost $sthost_decode;
	    }

	    rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

	    proxy_set_header Host $srchost;
	    proxy_set_header Stat-Type "";
	    proxy_set_header X-From-Cdn LECloud;
	    proxy_pass http://$lersrc_decode$uri$is_args$args;
    }

    location ~ /.*\.m3u8 {
        expires 6s;
        proxy_intercept_errors on;
        error_page 302 = @intercept_302;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;


        set $srchost $lersrc_decode;

        if ($arg_sthost != "") {
            set $srchost $sthost_decode;
        }

        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Host $srchost;
        proxy_set_header Stat-Type "";
        proxy_set_header X-From-Cdn LECloud;
        proxy_pass http://$lersrc_decode$uri$is_args$args;
    }       

    location @intercept_302 {
        expires_ext 30d;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        set $location_addr $upstream_http_location;

        if ($upstream_http_location = "") {
            add_header Powered-By-LetvNgx 404;
            return 404;
        }
        proxy_pass $location_addr;
    }
}

server {
   listen 16688;
   server_name  *.starschinalive.com;

   location / {
        expires 1d;
        proxy_intercept_errors on;
        error_page 302 = @intercept_302;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Host $lersrc_decode;
        proxy_set_header Stat-Type "";
        proxy_pass http://$lersrc_decode$uri;
    }

    location ~ ^/.*\.m3u8$ {
        proxy_intercept_errors on;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;
        error_page 405 = @RECYCLE;
        set $dst_args "path=$arg_origin_path&proxy=$arg_proxy&lersrc=$arg_lersrc&tag=$arg_tag&platid=$arg_platid&sign=$arg_sign";

        if ($http_letv_last = "1") {
            return 405;
        }

        subs_filter_types */* application/x-mpegURL;
        subs_filter (.*\.ts$) $1?$dst_args ir;
        subs_filter (.*\.m3u8$) $1?$dst_args ir;

        proxy_set_header Accept-Encoding "";
        proxy_set_header Stat-Type in;
        proxy_set_header Letv-Last 1;
        proxy_set_header Host $http_host;
        proxy_pass http://127.0.0.1:16688;
    }

    location @RECYCLE {
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;
        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        more_set_headers "Content-Type: application/x-mpegURL";
        proxy_set_header Stat-Type "";
        proxy_set_header Host $lersrc_decode;
        proxy_pass http://$lersrc_decode$uri?$args;
    }
}

server {
    listen 16688;
    server_name dl.store.boosj.com;
    include      set_var.conf;

    location / {
        expires_ext 2d;
        proxy_intercept_errors on;
        error_page 302 = @intercept_302;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Host $lersrc_decode;
        proxy_set_header Stat-Type "";
        proxy_pass http://$lersrc_decode$uri$is_args$args;
    }
}

server {
   listen 16688;
   server_name *.myccdn.info;

   location / {
        expires 1h;
        proxy_intercept_errors on;
        error_page 302 = @intercept_302;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Host $sthost_decode;
        proxy_set_header Stat-Type "";
        proxy_pass http://$lersrc_decode$uri;
    }

    location ~ ^/.*\.m3u8$ {
        proxy_intercept_errors on;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;
        error_page 405 = @RECYCLE;
        #set $dst_args "path=$arg_origin_path&proxy=$arg_proxy&lersrc=$arg_lersrc&tag=$arg_tag&platid=$arg_platid&sign=$arg_sign&sthost=$arg_sthost";

        if ($http_letv_last = "1") {
            return 405;
        }

        #subs_filter_types */* application/vnd.apple.mpegurl;
        #subs_filter (.*\.ts$) $1?$dst_args ir;

        proxy_set_header Accept-Encoding "";
        proxy_set_header Stat-Type in;
        proxy_set_header Letv-Last 1;
        proxy_set_header Host $sthost_decode;
        proxy_pass http://127.0.0.1:16688;
    }

    location @RECYCLE {
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;
        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Stat-Type "";
        proxy_set_header Host $sthost_decode;
        proxy_pass http://$lersrc_decode$uri;
    }
}

server {
   listen 16688;
   server_name *.huanqiugo.com;

   location / {
        expires 1d;
        proxy_intercept_errors on;
        error_page 302 = @intercept_302;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Host $lersrc_decode;
        proxy_set_header Stat-Type "";
        proxy_pass http://$lersrc_decode$uri;
    }

    location ~ ^/.*m3u8.*$ {
        proxy_intercept_errors on;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;
        error_page 405 = @RECYCLE;
        set $dst_args "path=$arg_origin_path&proxy=$arg_proxy&lersrc=$arg_lersrc&tag=$arg_tag&platid=$arg_platid&sign=$arg_sign";

        if ($http_letv_last = "1") {
            return 405;
        }

        subs_filter_types */* application/vnd.apple.mpegurl;
        subs_filter (.*ts.*$) /coopcdn/$http_host$1?$dst_args ir;

        proxy_set_header Accept-Encoding "";
        proxy_set_header Stat-Type in;
        proxy_set_header Letv-Last 1;
        proxy_set_header Host $http_host;
        proxy_pass http://127.0.0.1:16688;
    }

    location @RECYCLE {
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;
        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Stat-Type "";
        proxy_set_header Host $lersrc_decode;
        proxy_pass http://$lersrc_decode$uri;
    }
}

server {
   listen 16688;
   server_name *.m1905.com;

   location / {
        expires_ext 30d;
        proxy_intercept_errors on;
        error_page 302 = @intercept_302;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        set $srchost $lersrc_decode;
        set $trim_args $args;

        if ($trim_args ~* ^.*nkey2=.*?&(.*)?$) {
            set $trim_args $1;
        }

        if ($trim_args ~* (.*)&errc=.*$) {
            set $trim_args $1;
        }

        if ($trim_args ~* ^errc=.*$) {
            set $trim_args "";
        }

        if ($arg_sthost != "") {
            set $srchost $sthost_decode;
        }

        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Host $srchost;
        proxy_set_header Stat-Type "";
        proxy_set_header X-From-Cdn LECloud;
        proxy_pass http://$lersrc_decode$uri$is_args$trim_args;
    }
}

server {
   listen 16688;
   server_name *.51wofang.com;

   location / {
        expires 1d;
        proxy_intercept_errors on;
        error_page 302 = @intercept_302;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        set $srchost $lersrc_decode;
        set $trim_args $args;

        if ($trim_args ~* ^.*nkey2=.*?&(.*)?$) {
            set $trim_args $1;
        }

        if ($trim_args ~* (.*)&errc=.*$) {
            set $trim_args $1;
        }

        if ($trim_args ~* ^errc=.*$) {
            set $trim_args "";
        }

        if ($arg_sthost != "") {
            set $srchost $sthost_decode;
        }

        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Host $srchost;
        proxy_set_header Stat-Type "";
        proxy_set_header X-From-Cdn LECloud;
        proxy_pass http://$lersrc_decode$uri$is_args$trim_args;
    }


    location ~* .*(gif|jpg|jpeg|bmp|png|ico|txt|mp3|mp4|swf)$ {
        expires 15d;
        proxy_intercept_errors on;
        error_page 302 = @intercept_302;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        set $srchost $lersrc_decode;
        set $trim_args $args;

        if ($trim_args ~* ^.*nkey2=.*?&(.*)?$) {
            set $trim_args $1;
        }

        if ($trim_args ~* (.*)&errc=.*$) {
            set $trim_args $1;
        }

        if ($trim_args ~* ^errc=.*$) {
            set $trim_args "";
        }

        if ($arg_sthost != "") {
            set $srchost $sthost_decode;
        }

        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Host $srchost;
        proxy_set_header Stat-Type "";
        proxy_set_header X-From-Cdn LECloud;
        proxy_pass http://$lersrc_decode$uri$is_args$trim_args;
    }
}


server {
   listen 16688;
   server_name *.tuyoo.com;

   location / {
        proxy_intercept_errors on;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;
        gzip_http_version 1.0;

        set $srchost $lersrc_decode;
        set $trim_args $args;

        if ($trim_args ~* ^.*nkey2=.*?&(.*)?$) {
            set $trim_args $1;
        }

        if ($trim_args ~* (.*)&errc=.*$) {
            set $trim_args $1;
        }

        if ($trim_args ~* ^errc=.*$) {
            set $trim_args "";
        }

        if ($arg_sthost != "") {
            set $srchost $sthost_decode;
        }

        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Host $srchost;
        proxy_set_header Stat-Type "";
        proxy_set_header X-From-Cdn LECloud;
        proxy_pass http://$lersrc_decode$uri$is_args$trim_args;
   }
}

server {
   listen 16688;
   server_name apk.dl.tuyoo.com;

   location / {
	expires 30d;
        proxy_intercept_errors on;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;
        gzip_http_version 1.0;

        set $srchost $lersrc_decode;
        set $trim_args $args;

        if ($trim_args ~* ^.*nkey2=.*?&(.*)?$) {
            set $trim_args $1;
        }

        if ($trim_args ~* (.*)&errc=.*$) {
            set $trim_args $1;
        }

        if ($trim_args ~* ^errc=.*$) {
            set $trim_args "";
        }

        if ($arg_sthost != "") {
            set $srchost $sthost_decode;
        }

        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Host $srchost;
        proxy_set_header Stat-Type "";
        proxy_set_header X-From-Cdn LECloud;
        proxy_pass http://$lersrc_decode$uri$is_args$trim_args;
   }
}

server {
   listen 16688;
   server_name update.dl.tuyoo.com;

   location / {
        expires 30d;
        proxy_intercept_errors on;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;
        gzip_http_version 1.0;

        set $srchost $lersrc_decode;
        set $trim_args $args;

        if ($trim_args ~* ^.*nkey2=.*?&(.*)?$) {
            set $trim_args $1;
        }

        if ($trim_args ~* (.*)&errc=.*$) {
            set $trim_args $1;
        }

        if ($trim_args ~* ^errc=.*$) {
            set $trim_args "";
        }

        if ($arg_sthost != "") {
            set $srchost $sthost_decode;
        }

        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Host $srchost;
        proxy_set_header Stat-Type "";
        proxy_set_header X-From-Cdn LECloud;
        proxy_pass http://$lersrc_decode$uri$is_args$trim_args;
   }

   location ~ \.xml {
        expires 1m;
        proxy_intercept_errors on;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;
        gzip_http_version 1.0;
        gzip            on;
        gzip_min_length 300;
        gzip_proxied    any;
        gzip_types     text/plain application/xml;
        gzip_vary on;

        set $srchost $lersrc_decode;
        set $trim_args $args;

        if ($trim_args ~* ^.*nkey2=.*?&(.*)?$) {
            set $trim_args $1;
        }

        if ($trim_args ~* (.*)&errc=.*$) {
            set $trim_args $1;
        }

        if ($trim_args ~* ^errc=.*$) {
            set $trim_args "";
        }

        if ($arg_sthost != "") {
            set $srchost $sthost_decode;
        }

        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Host $srchost;
        proxy_set_header Stat-Type "";
        proxy_set_header X-From-Cdn LECloud;
        proxy_pass http://$lersrc_decode$uri$is_args$trim_args;
    }
}

server {
    listen 16688;
    server_name apkcdn.znds.com lecdn.znds.com cdn.dangbei.net;
    include      set_var.conf;

    location / {
        proxy_intercept_errors on;
        error_page 302 = @intercept_302;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        set $srchost $lersrc_decode;
        set $trim_args $args;

        if ($trim_args ~* ^.*nkey2=.*?&(.*)?$) {
            set $trim_args $1;
        }

        if ($trim_args ~* (.*)&errc=.*$) {
            set $trim_args $1;
        }

        if ($trim_args ~* ^errc=.*$) {
            set $trim_args "";
        }

        if ($arg_sthost != "") {
            set $srchost $sthost_decode;
        }

        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Host $srchost;
        proxy_set_header Stat-Type "";
        proxy_set_header X-From-Cdn LECloud;
        proxy_pass http://$lersrc_decode$uri$is_args$trim_args;
    }

    location ~ apk$|dangbei$|jpg$|jpeg$|gif$|png$|bmp$|flv$|mp4$|html$|htm$|txt$|dbsc$|txt$ {
        expires_ext 365d;
        proxy_intercept_errors on;
        error_page 302 = @intercept_302;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        set $srchost $lersrc_decode;
        set $trim_args $args;

        if ($trim_args ~* ^.*nkey2=.*?&(.*)?$) {
            set $trim_args $1;
        }

        if ($trim_args ~* (.*)&errc=.*$) {
            set $trim_args $1;
        }

        if ($trim_args ~* ^errc=.*$) {
            set $trim_args "";
        }

        if ($arg_sthost != "") {
            set $srchost $sthost_decode;
        }

        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Host $srchost;
        proxy_set_header Stat-Type "";
        proxy_set_header X-From-Cdn LECloud;
        proxy_pass http://$lersrc_decode$uri$is_args$trim_args;
    }

    location @intercept_302 {
        expires_ext 30d;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        set $location_addr $upstream_http_location;

        if ($upstream_http_location = "") {
            add_header Powered-By-LetvNgx 404;
            return 404;
        }
        proxy_pass $location_addr;
    }

}

server {
    listen 16688;
    server_name app.znds.com;
    include      set_var.conf;
    
    location / {
        expires_ext 30d;
        proxy_intercept_errors on;
        error_page 302 = @intercept_302;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        set $srchost $lersrc_decode;
        set $trim_args $args;

        if ($trim_args ~* ^.*nkey2=.*?&(.*)?$) {
            set $trim_args $1;
        }

        if ($trim_args ~* (.*)&errc=.*$) {
            set $trim_args $1;
        }

        if ($trim_args ~* ^errc=.*$) {
            set $trim_args "";
        }

        if ($arg_sthost != "") {
            set $srchost $sthost_decode;
        }

        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Host $srchost;
        proxy_set_header Stat-Type "";
        proxy_set_header X-From-Cdn LECloud;
        proxy_pass http://$lersrc_decode$uri$is_args$trim_args;
    }

    location ~* .*(apk|dangbei|jpg|jpeg|gif|png|bmp|flv|mp4|html|htm|txt|dbsc|ico|zip|rar|exe)$ {
        expires_ext 1y;
        proxy_intercept_errors on;
        error_page 302 = @intercept_302;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        set $srchost $lersrc_decode;
        set $trim_args $args;

        if ($trim_args ~* ^.*nkey2=.*?&(.*)?$) {
            set $trim_args $1;
        }

        if ($trim_args ~* (.*)&errc=.*$) {
            set $trim_args $1;
        }

        if ($trim_args ~* ^errc=.*$) {
            set $trim_args "";
        }

        if ($arg_sthost != "") {
            set $srchost $sthost_decode;
        }

        rewrite ^/coopcdn/.*?/(.*)$ /$1 break;

        proxy_set_header Host $srchost;
        proxy_set_header Stat-Type "";
        proxy_set_header X-From-Cdn LECloud;
        proxy_pass http://$lersrc_decode$uri$is_args$trim_args;
    }

    location @intercept_302 {
        expires_ext 30d;
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;

        set $location_addr $upstream_http_location;

        if ($upstream_http_location = "") {
            add_header Powered-By-LetvNgx 404;
            return 404;
        }
        proxy_pass $location_addr;
    }

}


