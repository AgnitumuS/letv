# For cooperation testing
include domains/chaoxing_referer.conf;

location ~ ^/coopcdn/cdn.jzsou.net/.*.(jpg|jpeg|gif|bmp|png)$ {
    return 403;
} 

location ~ ^/[0-9]+/[0-9]+/[0-9]+/acloud/101711/w3\.dwstatic\.com/.*\.mp4$ {
    set $proxyed HIT;
    root /letv/fet/;
    error_page 404 = @404_NOT_FOUND;

    if ( !-e $request_filename ) {
        watchdog      on;
    }

    mp4;
}

location ~ ^/[0-9]+/[0-9]+/[0-9]+/acloud/136098/video\.superlib\.com/.*$ {
    set $proxyed HIT;
    add_header Content-Disposition "attachment;filename=$content_dispostion_value.flv";
    root /letv/fet/;
    error_page 404 = @404_NOT_FOUND;

    if ( !-e $request_filename ) {
        watchdog      on;
    }

    flv;
}

location ~ ^/[0-9]+/[0-9]+/[0-9]+/.*muzhiwan.com/.* {
    set $proxyed HIT;
    error_page 404 = @404_NOT_FOUND;
    
    if ( !-e $request_filename ) {
        watchdog      on;
    }
    #limit_rate 1500k;

    #limit_conn_log_level error;
    #limit_conn muzhiwan_limit 1;
    #limit_conn_status 503;
    
}

location ~ ^/[0-9]+/[0-9]+/[0-9]+/acloud/136098/v.dev.leappmusic.cc(/.*) {
    error_page 404 = @404_NOT_FOUND;

    root /letv/fet/; 
    set $proxyed HIT;
    set $filename $1;
    access_by_lua '
        local t = ngx.var.arg_t
        local k = ngx.var.arg_k
        local filename = ngx.var.filename
        local md5sum = ngx.md5
        local salt = "video.test.dev"

        if k == nil or t == nil then
            ngx.exit(403)
        end

        if tonumber(t) < tonumber(os.time()) then
            ngx.exit(403)
        end

        local srt = string.sub(md5sum(salt..filename..t), 9, 24)

        if srt ~= k then
            ngx.exit(403)
        end
    ';

     mp4;
}

location ~ ^/[0-9]+/[0-9]+/[0-9]+/acloud/136098/v.leappmusic.cc(/.*) {
    error_page 404 = @404_NOT_FOUND;

    root /letv/fet/; 
    set $proxyed HIT;
    set $filename $1;
    access_by_lua '
        local t = ngx.var.arg_t
        local k = ngx.var.arg_k
        local filename = ngx.var.filename
        local md5sum = ngx.md5
        local salt = "v4v1nd1tt@"

        if k == nil or t == nil then
            ngx.exit(403)
        end

        if tonumber(t) < tonumber(os.time()) then
            ngx.exit(403)
        end

        local srt = string.sub(md5sum(salt..filename..t), 9, 24)

        if srt ~= k then
            ngx.exit(403)
        end
    ';

     mp4;
}

location ~ ^/[0-9]+/[0-9]+/[0-9]+/acloud/257384/.*.tvfan.cn(/.*.flv)$ {
    error_page 404 = @404_NOT_FOUND;

    root /letv/fet/; 
    set $proxyed HIT;
    set $filename $1;
    access_by_lua '
        local f3tm = ngx.var.arg_f3tm
        local f3key = ngx.var.arg_f3key
        local filename = ngx.var.filename
        local md5sum = ngx.md5
        local salt = "97878050mqrfq67"

        if f3tm == nil or f3key == nil then
            ngx.exit(403)
        end

        if tonumber(f3tm) < tonumber(os.time()) then
            ngx.exit(403)
        end

        local srt = md5sum(salt..filename..f3tm)

        if srt ~= f3key then
            ngx.exit(403)
        end
    ';
    flv;
}

location ~ ^/[0-9]+/[0-9]+/[0-9]+/acloud/257384/.*.tvfan.cn(/.*.mp4)$ {
    error_page 404 = @404_NOT_FOUND;

    root /letv/fet/; 
    set $proxyed HIT;
    set $filename $1;
    access_by_lua '
        local f3tm = ngx.var.arg_f3tm
        local f3key = ngx.var.arg_f3key
        local filename = ngx.var.filename
        local md5sum = ngx.md5
        local salt = "97878050mqrfq67"

        if f3tm == nil or f3key == nil then
            ngx.exit(403)
        end

        if tonumber(f3tm) < tonumber(os.time()) then
            ngx.exit(403)
        end

        local srt = md5sum(salt..filename..f3tm)

        if srt ~= f3key then
            ngx.exit(403)
        end
    ';
    mp4;
}

location ~ ^/[0-9]+/[0-9]+/[0-9]+/acloud/257384/.*.tvfan.cn(/.*.m3u8)$ {
    error_page 404 = @404_NOT_FOUND;

    root /letv/fet/; 
    set $proxyed HIT;
    set $filename $1;
    access_by_lua '
        local f3tm = ngx.var.arg_f3tm
        local f3key = ngx.var.arg_f3key
        local filename = ngx.var.filename
        local md5sum = ngx.md5
        local salt = "97878050mqrfq67"

        if f3tm == nil or f3key == nil then
            ngx.exit(403)
        end

        if tonumber(f3tm) < tonumber(os.time()) then
            ngx.exit(403)
        end

        local srt = md5sum(salt..filename..f3tm)

        if srt ~= f3key then
            ngx.exit(403)
        end
    ';
}


location ~ ^/[0-9]+/[0-9]+/[0-9]+/acloud/136098/gotyetest.ufile.ucloud.com.cn(/.*) {
    error_page 404 = @404_NOT_FOUND;

    root /letv/fet/; 
    set $proxyed HIT;
    set $filename $1;
    access_by_lua '
        local t = ngx.var.arg_t
        local k = ngx.var.arg_k
        local filename = ngx.var.filename
        local md5sum = ngx.md5
        local salt = "70bba472-ab9a-45ca-837a-78a1f6c3b177"

        if k == nil or t == nil then
            ngx.exit(403)
        end

        if tonumber(t) < tonumber(os.time()) then
            ngx.exit(403)
        end

        local srt = string.sub(md5sum(salt..filename..t), 9, 24)

        if srt ~= k then
            ngx.exit(403)
        end
    ';

     mp4;
}

location ~ ^/coopbig/.*.uzego.xingxiu.tv(/.*) {
    set $proxyed HIT;
    error_page 404 = @PATH_DELIVERY;
    proxy_intercept_errors on;
    proxy_connect_timeout 30s;
    proxy_send_timeout    45s;
    proxy_read_timeout    45s;
    proxy_set_header User-Agent $http_user_agent;
    proxy_set_header Connection "Keep-Alive";
    set $filename $1;

    access_by_lua '
        local t = ngx.var.arg_t
        local k = ngx.var.arg_k
        local filename = ngx.var.filename
        local md5sum = ngx.md5
        local salt = "54b63b369c83be428a7e46"

        if k == nil or t == nil then
            ngx.exit(403)
        end

        if tonumber(t) < tonumber(os.time()) then
            ngx.exit(403)
        end

        local srt = string.sub(md5sum(salt..filename..t), 9, 24)

        if srt ~= k then
            ngx.exit(403)
        end
    ';

    proxy_set_header Host $lersrc_decode;
    proxy_set_header Stat-Type $rrate;
    proxy_pass http://ngx_backend$uri?$args;
}

location ~ ^/coopbig/dianbo.uzego.xingxiu.tv(/.*) {
    set $proxyed HIT;
    proxy_intercept_errors on;
    proxy_connect_timeout 30s;
    proxy_send_timeout    45s;
    proxy_read_timeout    45s;
    proxy_set_header User-Agent $http_user_agent;
    proxy_set_header Connection "Keep-Alive";
    set $filename $1;

    access_by_lua '
        local t = ngx.var.arg_t
        local k = ngx.var.arg_k
        local filename = ngx.var.filename
        local md5sum = ngx.md5
        local salt = "54123b369c8c2e429d7e21"

        if k == nil or t == nil then
            ngx.exit(403)
        end

        if tonumber(t) < tonumber(os.time()) then
            ngx.exit(403)
        end

        local srt = string.sub(md5sum(salt..filename..t), 9, 24)

        if srt ~= k then
            ngx.exit(403)
        end
    ';

    proxy_set_header Host $lersrc_decode;
    proxy_set_header Stat-Type $rrate;
    proxy_pass http://ngx_backend$uri?$args;
}

location ~ ^/coopbig/dianbo.demo.zego.im(/.*) {
    set $proxyed HIT;
    proxy_intercept_errors on;
    proxy_connect_timeout 30s;
    proxy_send_timeout    45s;
    proxy_read_timeout    45s;
    proxy_set_header User-Agent $http_user_agent;
    proxy_set_header Connection "Keep-Alive";
    set $filename $1;

    access_by_lua '
        local t = ngx.var.arg_t
        local k = ngx.var.arg_k
        local filename = ngx.var.filename
        local md5sum = ngx.md5
        local salt = "54b63b369c83be428a7e46"

        if k == nil or t == nil then
            ngx.exit(403)
        end

        if tonumber(t) < tonumber(os.time()) then
            ngx.exit(403)
        end

        local srt = string.sub(md5sum(salt..filename..t), 9, 24)

        if srt ~= k then
            ngx.exit(403)
        end
    ';

    proxy_set_header Host $lersrc_decode;
    proxy_set_header Stat-Type $rrate;
    proxy_pass http://ngx_backend$uri?$args;
}

location ~ ^/coopbig/v.dev.leappmusic.cc(/.*) {
    set $proxyed HIT;
    proxy_intercept_errors on;
    proxy_connect_timeout 30s;
    proxy_send_timeout    45s;
    proxy_read_timeout    45s;
    proxy_set_header User-Agent $http_user_agent;
    proxy_set_header Connection "Keep-Alive";
    set $filename $1;

    access_by_lua '
        local t = ngx.var.arg_t
        local k = ngx.var.arg_k
        local filename = ngx.var.filename
        local md5sum = ngx.md5
        local salt = "video.test.dev"

        if k == nil or t == nil then
            ngx.exit(403)
        end

        if tonumber(t) < tonumber(os.time()) then
            ngx.exit(403)
        end

        local srt = string.sub(md5sum(salt..filename..t), 9, 24)

        if srt ~= k then
            ngx.exit(403)
        end
    ';

    proxy_set_header Host $lersrc_decode;
    proxy_set_header Stat-Type $rrate;
    proxy_pass http://ngx_backend$uri?$args;
}

location ~ ^/coopbig/v.leappmusic.cc(/.*) {
    set $proxyed HIT;
    proxy_intercept_errors on;
    proxy_connect_timeout 30s;
    proxy_send_timeout    45s;
    proxy_read_timeout    45s;
    proxy_set_header User-Agent $http_user_agent;
    proxy_set_header Connection "Keep-Alive";
    set $filename $1;

    access_by_lua '
        local t = ngx.var.arg_t
        local k = ngx.var.arg_k
        local filename = ngx.var.filename
        local md5sum = ngx.md5
        local salt = "v4v1nd1tt@"

        if k == nil or t == nil then
            ngx.exit(403)
        end

        if tonumber(t) < tonumber(os.time()) then
            ngx.exit(403)
        end

        local srt = string.sub(md5sum(salt..filename..t), 9, 24)

        if srt ~= k then
            ngx.exit(403)
        end
    ';

    proxy_set_header Host $lersrc_decode;
    proxy_set_header Stat-Type $rrate;
    proxy_pass http://ngx_backend$uri?$args;
}

location ~ ^/coopbig/gotyetest.ufile.ucloud.com.cn(/.*) {
    set $proxyed HIT;
    proxy_intercept_errors on;
    proxy_connect_timeout 30s;
    proxy_send_timeout    45s;
    proxy_read_timeout    45s;
    proxy_set_header User-Agent $http_user_agent;
    proxy_set_header Connection "Keep-Alive";
    set $filename $1;

    access_by_lua '
        local t = ngx.var.arg_t
        local k = ngx.var.arg_k
        local filename = ngx.var.filename
        local md5sum = ngx.md5
        local salt = "70bba472-ab9a-45ca-837a-78a1f6c3b177"

        if k == nil or t == nil then
            ngx.exit(403)
        end

        if tonumber(t) < tonumber(os.time()) then
            ngx.exit(403)
        end

        local srt = string.sub(md5sum(salt..filename..t), 9, 24)

        if srt ~= k then
            ngx.exit(403)
        end
    ';

    proxy_set_header Host $lersrc_decode;
    proxy_set_header Stat-Type $rrate;
    proxy_pass http://ngx_backend$uri?$args;
}

location ~ ^/coopbig/leapp-test.ufile.ucloud.com.cn(/.*) {
    set $proxyed HIT;
    proxy_intercept_errors on;
    proxy_connect_timeout 30s;
    proxy_send_timeout    45s;
    proxy_read_timeout    45s;
    proxy_set_header User-Agent $http_user_agent;
    proxy_set_header Connection "Keep-Alive";
    set $filename $1;

    access_by_lua '
        local t = ngx.var.arg_t
        local k = ngx.var.arg_k
        local filename = ngx.var.filename
        local md5sum = ngx.md5
        local salt = "leappmusic.test"

        if k == nil or t == nil then
            ngx.exit(403)
        end

        if tonumber(t) < tonumber(os.time()) then
            ngx.exit(403)
        end

        local srt = string.sub(md5sum(salt..filename..t), 9, 24)

        if srt ~= k then
            ngx.exit(403)
        end
    ';

    proxy_set_header Host $lersrc_decode;
    proxy_set_header Stat-Type $rrate;
    proxy_pass http://ngx_backend$uri?$args;
}

location ~ ^/[0-9]+/[0-9]+/[0-9]+/acloud/136098/(.*.ufile.ucloud.com.cn)(/.*\.mp4) {
    error_page 404 = @404_NOT_FOUND;

    set $server_host $1;
    set $filename $2;
    access_by_lua '

	if ngx.var.server_host == "yfkj-bgwx-zcxfgcs.ufile.ucloud.com.cn" then
            local t = ngx.var.arg_t
            local k = ngx.var.arg_k
            local filename = ngx.var.filename
            local md5sum = ngx.md5
            local salt = "ynjinxiang"

            if k == nil or t == nil then
                ngx.exit(403)
            end

            if tonumber(t) < tonumber(os.time()) then
                ngx.exit(403)
            end

            local srt = string.sub(md5sum(salt..filename..t), 9, 24)

            if srt ~= k then
                ngx.exit(403)
            end
	end

    ';

    if ( !-e $request_filename ) {
        return 404;
    }

    if ($arg_vtag = "tvts") {
        rewrite ^/(.*)$ /video2/iphone/$1?first_vtime=10&second_vtime=10&ave_vtime=10 last;
    }

    mp4;
}


location ~ ^/[0-9]+/[0-9]+/[0-9]+/acloud/136098/(.*.ufile.ucloud.com.cn)(/.*\.flv)$ {
    set $proxyed HIT;
    root /letv/fet/;
    error_page 404 = @404_NOT_FOUND;

    set $server_host $1;
    set $filename $2;
    access_by_lua '

	if ngx.var.server_host == "yfkj-bgwx-zcxfgcs.ufile.ucloud.com.cn" then
            local t = ngx.var.arg_t
            local k = ngx.var.arg_k
            local filename = ngx.var.filename
            local md5sum = ngx.md5
            local salt = "ynjinxiang"

            if k == nil or t == nil then
                ngx.exit(403)
            end

            if tonumber(t) < tonumber(os.time()) then
                ngx.exit(403)
            end

            local srt = string.sub(md5sum(salt..filename..t), 9, 24)

            if srt ~= k then
                ngx.exit(403)
            end
	end

    ';


    if ( !-e $request_filename ) {
        watchdog      on;
    }

    flv;
}

location ~ ^/[0-9]+/[0-9]+/[0-9]+/acloud/151672/letv\.v\.yinyuetai\.com/.*\.(flv|mp4)$ {
    root /letv/fet/;
    error_page 404 = @404_NOT_FOUND;
    set $proxyed HIT;

    types {
         video/mp4                flv;
    }

    if ( !-e $request_filename ) {
        watchdog      on;
    }

    mp4;
}

location ~ ^/coopbig/d.appstore.huan.tv/.* {
    set $proxyed HIT;
    error_page 404 = @PATH_DELIVERY;
    proxy_intercept_errors on;
    proxy_connect_timeout 30s;
    proxy_send_timeout    45s;
    proxy_read_timeout    45s;
    proxy_set_header User-Agent $http_user_agent;
    proxy_set_header Connection "Keep-Alive";

    if ($http_stat_type = "in") {
        return 405;
    }

    if ($http_letv = "1") {
       return 405;
    }

    if ( !-e $request_filename ) {
        watchdog coopbig;
    }

    rewrite ^/coopbig/d.appstore.huan.tv/appicon/(.*)/TCL/.*/app_(.*).apk  /coopbig/d.appstore.huan.tv/appicon/$1/TCL/app_$2.apk break;
    rewrite ^/coopbig/d.appstore.huan.tv/appicon/(.*)/CH/.*/app_(.*).cha   /coopbig/d.appstore.huan.tv/appicon/$1/CH/app_$2.cha break;

}

location ~ ^/[0-9]+/[0-9]+/[0-9]+/acloud/256567/stream2\.yunxuetang\.com/.*\.flv$ {
    root /letv/fet/;
    error_page 404 = @404_NOT_FOUND;
    set $proxyed HIT;

    if ( !-e $request_filename ) {
        watchdog      on;
    }

    flv;
}

location ~ ^/[0-9]+/[0-9]+/[0-9]+/acloud/256567/stream2\.yunxuetang\.cn/.*\.flv$ {
    root /letv/fet/;
    error_page 404 = @404_NOT_FOUND;
    set $proxyed HIT;

    if ( !-e $request_filename ) {
        watchdog      on;
    }

    flv;
}

location ~ ^/[0-9]+/[0-9]+/[0-9]+/acloud/136098/v\.isenba\.com/.*\.mp4$ {
    root /letv/fet/;
    set $proxyed HIT;

    error_page 503 = @503_SECURE_OK;

    proxy_connect_timeout 30s;
    proxy_send_timeout    45s;
    proxy_read_timeout    45s;

    if ($arg_last = "1") {
        return 503;
    }

    set $ouri $request_uri&last=1;

    rewrite ^/[0-9]+/[0-9]+/[0-9]+/acloud/136098/v\.isenba\.com/(.*)$ /$1 break;

    proxy_set_header ouri $ouri;
    proxy_pass http://ngx_backend/coopbig/f3.security.com.v.isenba.com$uri?$args;
}


location ~ ^/[0-9]+/[0-9]+/[0-9]+/acloud/143558/.*\.audiocn\.org/.*$ {
    root /letv/fet/;
    error_page 503 = @503_SECURE_OK;
    set $proxyed HIT;

    proxy_connect_timeout 30s;
    proxy_send_timeout    45s;
    proxy_read_timeout    45s;

    if ($arg_cuhost !~ lecdn\d+\.audiocn\.org) {
        return 503;
    }

    if ($arg_last = "1") {
        return 503;
    }

    set $ouri $request_uri&last=1;

    rewrite ^/[0-9]+/[0-9]+/[0-9]+/acloud/143558/.*\.audiocn\.org/(.*)$ /$1 break;

    proxy_set_header ouri $ouri;
    proxy_pass http://ngx_backend/coopbig/f3.security.com.lecdn.audiocn.org$uri?$args;
}

location ~ ^/coopbig/f3.security.com.v.isenba.com {
    letv_secure_link_secret 30eb0b0be74bdf50;
    set $sec_ok "not_ok";
    set $secure_link_v2_log $secure_link_v3;
    set $proxyed HIT;

    if ($secure_link_v2_log = "ok") {
        set $sec_ok "ok";
    }

    if ($sec_ok != "ok") {
        return 403;
    }

    proxy_send_timeout    45s;
    proxy_read_timeout    45s;
    proxy_pass http://ngx_backend$http_ouri;
}

location ~ ^/coopbig/f3.security.com.lecdn.audiocn.org {
    set $proxyed HIT;
    letv_secure_link_secret d228666c03c3fdfec90f831cab2693d3;
    set $sec_ok "not_ok";
    set $secure_link_v2_log $secure_link_v3;

    if ($secure_link_v2_log = "ok") {
        set $sec_ok "ok";
    }

    if ($sec_ok != "ok") {
        return 403;
    }

    proxy_send_timeout    45s;
    proxy_read_timeout    45s;
    proxy_pass http://ngx_backend$http_ouri;
}


location @503_SECURE_OK {
    root /letv/fet/;
    error_page 404 = @404_NOT_FOUND;

    mp4;
}

location @AIPAI_FLV_LOC {
    error_page 404 = @404_NOT_FOUND;
    limit_rate_after 2m;
    buffer_header off;
    set $proxyed HIT;

    if ( !-e $request_filename ) {
    	watchdog      on;
    }

    flv;
}

location @AIPAI_MP4_LOC {
    error_page 404 = @404_NOT_FOUND;
    limit_rate_after 2m;
    buffer_header off;

    if ( !-e $request_filename ) {
    	watchdog      on;
    }

    mp4;
}

location @H264_MP4_UCLOUD {
    error_page 404 = @404_NOT_FOUND;
    limit_rate_after 0k;
    limit_rate 0;
    set $limit_rate 0k;
    mp4;
}

location @NEW_MP4_UCLOUD {
    error_page 404 = @404_NOT_FOUND;
    limit_rate_after 0k;
    limit_rate 0;
    set $limit_rate 0k;
    mp4;
}

location @H264_FLV_UCLOUD {
    add_header Content-Disposition "attachment;filename=$content_dispostion_value.flv";
    error_page 404 = @404_NOT_FOUND;
    default_type video/x-flv;
    limit_rate_after 0k;
    limit_rate 0;
    set $limit_rate 0k;
    flv;
}

location @OTHER_UCLOUD {
    error_page 404 = @404_NOT_FOUND;
    error_page 406 = @H264_MP4_UCLOUD;
    error_page 405 = @H264_FLV_UCLOUD;
    error_page 407 = @NEW_MP4_UCLOUD;
    limit_rate_after 0k;
    limit_rate 0;
    set $limit_rate 0k;

    if ($uri ~* "^.*\.ananas\.chaoxing\.com/.*\.mp4$") {
        return 406; 
    }
   
    if ($arg_cuhost ~* "^.*play\.wxbgt\.com$") {
        return 406;
    }
  
    if ($arg_cuhost ~* "^.*video\.superlib\.com$") {
        return 405;
    }
 
    if ($uri ~* "^.*\.mp4$") {
        return 407;
    }
}


location ~ ^(.*)\.ananas\.chaoxing\.com/.*\.mp4 {
    error_page 412 = @H264_MP4_UCLOUD;
    proxy_set_header trans 1;
    proxy_connect_timeout 100s;
    proxy_read_timeout 100s;
    proxy_send_timeout 100s;

    if ( $http_trans != "" ) {
        return 412;
    }
    set $nargs $args;
    if ( $arg_vbegin != "" ) {
       set $nargs $nargs&start=$arg_vbegin;
    }

    if ( $arg_vend != "" ) {
       set $nargs $nargs&end=$arg_vend;
    }

    proxy_pass http://127.0.0.1$uri?$nargs;
}

location ~ ^/[0-9]+/[0-9]+/[0-9]+/acloud/106551/.*$ {
    set $proxyed HIT;
    error_page 406 = @AIPAI_FLV_LOC;
    error_page 407 = @AIPAI_MP4_LOC;
    error_page 405 = @OTHER_UCLOUD;

    limit_rate_after 2m;
    set $limit_rate 60k;
    add_header "AIPAI-LIMIT" $limit_rate;

    if ($arg_cuhost !~ ".*\.aipai\.com") {
	return 405;
    }
    
    if ($arg_l = "a") {
        set $limit_rate 28k;
    }
    
    if ($arg_l = "b") {
        set $limit_rate 34k;
    }
    
    if ($arg_l = "c") {
        set $limit_rate 40k;
    }
    
    if ($arg_l = "d") {
        set $limit_rate 47k;
    }
    
    if ($arg_l = "e") {
        set $limit_rate 53k;
    }
    
    if ($arg_l = "f") {
        set $limit_rate 59k;
    }
    
    if ($arg_l = "g") {
        set $limit_rate 65k;
    }
    
    if ($arg_l = "h") {
        set $limit_rate 72k;
    }
    
    if ($arg_l = "i") {
        set $limit_rate 78k;
    }
    
    if ($arg_l = "j") {
        set $limit_rate 84k;
    }
    
    if ($arg_l = "k") {
        set $limit_rate 90k;
    }
    
    if ($arg_l = "l") {
        set $limit_rate 96k;
    }
    
    if ($arg_l = "m") {
        set $limit_rate 103k;
    }
    
    if ($arg_l = "n") {
        set $limit_rate 109k;
    }
    
    if ($arg_l = "o") {
        set $limit_rate 115k;
    }
    
    if ($arg_l = "p") {
        set $limit_rate 122k;
    }
    
    if ($arg_l = "q") {
        set $limit_rate 128k;
    }
    
    if ($arg_l = "r") {
        set $limit_rate 134k;
    }
    
    if ($arg_l = "s") {
        set $limit_rate 140k;
    }
    
    if ($arg_l = "t") {
        set $limit_rate 147k;
    }
     
    if ($arg_l = "u") {
        set $limit_rate 153k;
    }
    
    if ($arg_l = "v") {
        set $limit_rate 161k;
    }

    if ($arg_keep_stopp = "on") {
        set $limit_rate 0;
    }
   
    if ($uri ~* "^.*\.flv$") {
	return 406;
    }

    if ($uri ~* "^.*\.mp4$") {
	return 407;
    } 
}

location ~ ^/[0-9]+/[0-9]+/[0-9]+/acloud/136098/.*$ {
    set $proxyed HIT;
    error_page 406 = @AIPAI_FLV_LOC;
    error_page 407 = @AIPAI_MP4_LOC;
    error_page 405 = @OTHER_UCLOUD;

    limit_rate_after 1892k;
    set $limit_rate 60k;
    add_header "AIPAI-LIMIT" $limit_rate;

    if ( $arg_cc = "ios" ) {
        rewrite ^/(.*)$ /video/iphone/$1 last;
    }

    if ($arg_cuhost !~ ".*\.aipai\.com") {
	return 405;
    }
    
    if ($arg_l = "a") {
        set $limit_rate 28k;
    }
    
    if ($arg_l = "b") {
        set $limit_rate 34k;
    }
    
    if ($arg_l = "c") {
        set $limit_rate 40k;
    }
    
    if ($arg_l = "d") {
        set $limit_rate 47k;
    }
    
    if ($arg_l = "e") {
        set $limit_rate 53k;
    }
    
    if ($arg_l = "f") {
        set $limit_rate 59k;
    }
    
    if ($arg_l = "g") {
        set $limit_rate 65k;
    }
    
    if ($arg_l = "h") {
        set $limit_rate 72k;
    }
    
    if ($arg_l = "i") {
        set $limit_rate 78k;
    }
    
    if ($arg_l = "j") {
        set $limit_rate 84k;
    }
    
    if ($arg_l = "k") {
        set $limit_rate 90k;
    }
    
    if ($arg_l = "l") {
        set $limit_rate 96k;
    }
    
    if ($arg_l = "m") {
        set $limit_rate 103k;
    }
    
    if ($arg_l = "n") {
        set $limit_rate 109k;
    }
    
    if ($arg_l = "o") {
        set $limit_rate 115k;
    }
    
    if ($arg_l = "p") {
        set $limit_rate 122k;
    }
    
    if ($arg_l = "q") {
        set $limit_rate 128k;
    }
    
    if ($arg_l = "r") {
        set $limit_rate 134k;
    }
    
    if ($arg_l = "s") {
        set $limit_rate 140k;
    }
    
    if ($arg_l = "t") {
        set $limit_rate 147k;
    }
     
    if ($arg_l = "u") {
        set $limit_rate 153k;
    }
    
    if ($arg_l = "v") {
        set $limit_rate 161k;
    }

    if ($arg_keep_stopp = "on") {
        set $limit_rate 0;
    }
   
    if ($uri ~* "^.*\.flv$") {
	return 406;
    }

    if ($uri ~* "^.*\.mp4$") {
	return 407;
    } 
}

location ~ ^/coopbig/[^\/]*.cztv.com {
    set $proxyed HIT;
    include domains/cztv_referer.conf;
    error_page 404 = @CZTV_PATH_DELIVERY;
    mp4;
}

location ~ ^/coopbig/v.isenba.com {
    set $proxyed HIT;
    proxy_intercept_errors on;
    error_page 405 = @COOPBIG_DEFAULT;
    proxy_connect_timeout 30s;
    proxy_send_timeout    45s;
    proxy_read_timeout    45s;
    proxy_set_header User-Agent $http_user_agent;
    proxy_set_header Connection "Keep-Alive";
    proxy_hide_header AIPAI-LIMIT;

    letv_secure_link_secret 30eb0b0be74bdf50;
    set $sec_ok "not_ok";
    set $secure_link_v2_log $secure_link_v3;

    if ($secure_link_v2_log = "ok") {
        set $sec_ok "ok";
    }

    if ($arg_last = "1") {
        set $sec_ok "ok";
    }

    if ($sec_ok != "ok") {
        return 403;
    }

    set $last_flag "&last=1";

    set $flag "0";
    if ($arg_tag = "watchdog") {
        set $flag "${flag}1";
        set $last_flag "";
    }

    if ($arg_last = "1") {
        set $flag "${flag}2";
    }

    if ($flag = "02") {
        return 405;
    }

    if ($uri ~* "^/coopbig/(.*?)/.*$") {
        set $user_host $1;
    }

    set $rrate "in";


    if ($uri ~* "^/coopbig/.*\.aipai\.com/.*$") {
        set $rrate "";
    }

    if ($lersrc_decode ~* "^.*\.src\.ucloud\.com\.cn$") {
        set $user_host $lersrc_decode;
    }

    proxy_set_header Host $user_host;
    proxy_set_header Stat-Type $rrate;
    proxy_pass http://ngx_backend$uri?$args$last_flag;
}

location ~ ^/coopbig/.*/acloud/ {
    return 403;
}

location ~ ^/coopbig/.*/coopbig/ {
    return 403;
}

# cooperation cdn for big file
location ~ ^/coopbig/ {
    set $proxyed HIT;
    proxy_intercept_errors on;
    error_page 405 = @COOPBIG_DEFAULT;
    proxy_connect_timeout 30s;
    proxy_send_timeout    45s;
    proxy_read_timeout    45s;
    proxy_set_header User-Agent $http_user_agent;
    proxy_set_header Connection "Keep-Alive";
    proxy_hide_header AIPAI-LIMIT;

    set $last_flag "&last=1";

    set $flag "0";
    if ($arg_tag = "watchdog") {
	set $flag "${flag}1";
	set $last_flag "";
    }

    if ($arg_last = "1") {
        set $flag "${flag}2";
    }

    if ($flag = "02") {
	return 405;
    }
    
    if ($uri ~* "^/coopbig/(.*?)/.*$") {
        set $user_host $1;
    } 

    if ($user_host = "tcl-cd-appstore.qiniudn.com") {
        add_header x-from-cdn "tcl-cd-appstore.qiniudn.com";
    }

    if ($user_host = "7xjlfn.media1.z0.glb.clouddn.com") {
        add_header x-from-cdn "tcl-cd-appstore.qiniudn.com";
    }

    if ($user_host = "videocdn.eebbk.net") {
        add_header x-from-cdn "tcl-cd-appstore.qiniudn.com";
    }

    set $rrate "in";


    if ($uri ~* "^/coopbig/.*\.aipai\.com/.*$") {
	set $rrate "";
    }

    if ($lersrc_decode ~* "^.*\.src\.ucloud\.com\.cn$") {
        set $user_host $lersrc_decode; 
    }

    if ($uri ~* "^/coopbig/.*\.yunxuetang\.cn/.*$") {
        set $user_host "LETV.com";
    }

    if ($uri ~* "^/coopbig/.*\.yunxuetang\.com/.*$") {
        set $user_host "LETV.com";
    }

    if ($uri ~* "^/coopbig/.*\.open\.com\.cn/.*$") {
        set $user_host "LETV.com";
    }

    if ($uri ~* "^/coopbig/.*\.mukewang\.com/.*$") {
        set $user_host "LETV.com";
    }

    if ($uri ~* "^/coopbig/.*\.huhatv\.com/.*$") {
        set $user_host "LETV.com";
    }

    if ($uri ~* "^/coopbig/.*\.imgo\.tv/.*$") {
        set $user_host "LETV.com";
    }

    if ($uri ~* "^/coopbig/adown\.myaora\.net/.*$") {
        set $user_host "LETV.com";
    }

    if ($arg_letv_cname = "1") {
        set $user_host "LETV.com";
    }
  
    proxy_set_header Host $user_host;
    proxy_set_header Stat-Type $rrate;
    proxy_pass http://ngx_backend$uri?$args$last_flag;
}

location @COOPBIG_FLV_LOC {
    set $proxyed HIT;
    error_page 404 = @PATH_DELIVERY;
    error_page 411 = @COOPBIG_FLV_DRAG;

    if ( !-e $request_filename ) {
        watchdog coopbig;
    }
   
    flv;
}

location @COOPBIG_FLV_DRAG {
    set $proxyed HIT;
    error_page 404 = @PATH_DELIVERY;
    if ( !-e $request_filename ) {
        watchdog coopbig;
    }
    flv_mp4_streaming;
}


location @COOPBIG_DEFAULT {
    set $proxyed HIT;
    more_set_headers "Le_Status: $proxyed";
    error_page 404 = @PATH_DELIVERY;
    error_page 407 = @COOPBIG_FLV_LOC;
    if ( !-e $request_filename ) {
        watchdog coopbig;
    }

    if ($uri ~* "^.*\.flv$") {
        return 407;
    }
    mp4;
}

location @PATH_DELIVERY {
    proxy_intercept_errors on;
    error_page 406 502 504 503 500 = @COOPBIG_FIRST_NOT_FOUND;
    proxy_connect_timeout 30s;
    proxy_send_timeout    45s;
    proxy_read_timeout    45s;
    proxy_set_header User-Agent $http_user_agent;
    proxy_set_header Connection "Keep-Alive";
    proxy_set_header X-IP $remote_addr;
    proxy_set_header X-Real-IP $host;
    set $proxyed MISS;

    if ($broadcast_proxy_ip = "") {
        return 406;
    }

    if ($broadcast_proxy_ip = "0") {
        return 406;
    }

    if ($uri ~* "^/coopbig/(.*?)/.*$") {
        set $user_host $1;
    } 
   
    if ($uri ~* "^/coopbig/.*\.yunxuetang\.cn/.*$") {
        set $user_host "LETV.com";
    }

    if ($uri ~* "^/coopbig/.*\.yunxuetang\.com/.*$") {
        set $user_host "LETV.com";
    }

    if ($uri ~* "^/coopbig/.*\.open\.com\.cn/.*$") {
        set $user_host "LETV.com";
    }

    if ($uri ~* "^/coopbig/.*\.mukewang\.com/.*$") {
        set $user_host "LETV.com";
    }

    if ($uri ~* "^/coopbig/.*\.huhatv\.com/.*$") {
        set $user_host "LETV.com";
    }

    if ($uri ~* "^/coopbig/.*\.imgo\.tv/.*$") {
        set $user_host "LETV.com";
    }

    if ($uri ~* "^/coopbig/adown\.myaora\.net/.*$") {
	    set $user_host "LETV.com";
    }

    if ($arg_letv_cname = "1") {
        set $user_host "LETV.com";
    }

    proxy_set_header Host $user_host; 
    proxy_pass http://$broadcast_proxy_ip$uri?$broadcast_proxy_args;
}

location @CZTV_PATH_DELIVERY {
    proxy_intercept_errors on; 
    error_page 406 502 504 503 500 = @CZTV_COOPBIG_FIRST_NOT_FOUND;
    error_page 405 = @PATH_DELIVERY;
    proxy_connect_timeout 30s;
    proxy_send_timeout    45s;
    proxy_read_timeout    45s;
    proxy_set_header User-Agent $http_user_agent;
    proxy_set_header Connection "Keep-Alive";
    proxy_set_header X-IP $remote_addr;
    proxy_set_header X-Real-IP $host;
    set $proxyed MISS;

    set $end "0";
    set $start "0";

    if ( $arg_end != "" ) {
        return 405;
    }

    if ( $arg_start != "" ) {
        set $start "1";
    }

    if ( $arg_start = "0" ) {
        set $start "0";
    }

    if ( $start = "1" ) {
        return 405;
    }


    if ($broadcast_proxy_ip = "") {
        return 406;
    }

    if ($broadcast_proxy_ip = "0") {
        return 406;
    }

    if ($uri ~* "^/coopbig/(.*?)/.*$") {
        set $user_host $1;
    }

    proxy_store on;       
    proxy_store_access user:rw group:rw all:rw;
    proxy_set_header Host $user_host;
    proxy_pass http://$broadcast_proxy_ip$uri?$broadcast_proxy_args;
}

location @COOPBIG_SECOND_NOT_FOUND {
   proxy_set_header X-Real-IP $host;
   proxy_set_header host $host;
   proxy_set_header X-IP $remote_addr;
   proxy_set_header Stat-Type in;
   proxy_connect_timeout 30s;
   proxy_send_timeout    45s;
   proxy_read_timeout    45s;
   set $proxyed MISS;
   
   proxy_store off;
   if ($proxy_second_ip = "") {
        return 404;
   }
   if ($proxy_second_ip ~ ([^:]*) ) {
        set $oip $1;
   }
  
   if ($oip = $server_addr) {
        return 404;
   }

   proxy_pass http://$proxy_second_ip$uri?$args;
}

location @CZTV_COOPBIG_SECOND_NOT_FOUND {
   proxy_set_header X-Real-IP $host;
   proxy_set_header host $host;
   proxy_set_header X-IP $remote_addr;
   proxy_set_header Stat-Type in;
   proxy_connect_timeout 30s;
   proxy_send_timeout    45s;
   proxy_read_timeout    45s;
   set $proxyed MISS;

   proxy_store on;
   proxy_store_access user:rw group:rw all:rw; 
   if ($proxy_second_ip = "") {
        return 404;
   }

   if ($proxy_second_ip ~ ([^:]*) ) {
       set $oip $1;
   }   

   if ($oip = $server_addr) {
        return 404;
   }

   proxy_pass http://$proxy_second_ip$uri?$args;
}

location @COOPBIG_FIRST_NOT_FOUND {
    proxy_intercept_errors on;
    #error_page 404 502 500 504 503 = @COOPBIG_SECOND_NOT_FOUND;
    set $proxyed MISS;
    more_set_headers "Le_Status: $proxyed";
    proxy_hide_header Le_Status;

    proxy_set_header X-Real-IP $host;
    proxy_set_header host $host;
    proxy_set_header X-IP $remote_addr;
    proxy_set_header Stat-Type in;
    proxy_connect_timeout 30s;
    proxy_send_timeout    45s;
    proxy_read_timeout    45s;

    proxy_store off;

    if ($proxy_first_ip = "") {
        return 404;
    }
 
    if ($proxy_first_ip ~ ([^:]*) ) {
        set $oip $1;
    }

    if ($oip = $server_addr) {
        return 404;
    }

    proxy_pass http://$proxy_first_ip$uri?$args;
}

location @CZTV_COOPBIG_FIRST_NOT_FOUND {
    proxy_intercept_errors on;
    error_page 404 502 500 504 503 = @CZTV_COOPBIG_SECOND_NOT_FOUND;
    set $proxyed MISS;

    proxy_set_header X-Real-IP $host;
    proxy_set_header host $host;
    proxy_set_header X-IP $remote_addr;
    proxy_set_header Stat-Type in;
    proxy_connect_timeout 30s;
    proxy_send_timeout    45s;
    proxy_read_timeout    45s;

    proxy_store on;
    proxy_store_access user:rw group:rw all:rw; 

    if ($proxy_first_ip = "") {
        return 404;
    }


    if ($proxy_first_ip ~ ([^:]*) ) {
        set $oip $1;
    }

    if ($oip = $server_addr) {
        return 404;
    } 
    
    proxy_pass http://$proxy_first_ip$uri?$args;
}


location ~ ^/coopcdn/livetv.yncuc.net/.*\.m3u8 {
    proxy_intercept_errors on;
    error_page 405 = @COOP_GSLB;
    proxy_connect_timeout 30s;
    proxy_send_timeout    45s;
    proxy_read_timeout    45s;

    proxy_set_header Accept-Encoding "";
    subs_filter_types */* application/vnd.apple.mpegurl;
    subs_filter (.*\.ts).*    $1?$args ir;
    subs_filter (.*\.m3u8)\?.*  $1?$args ir;

    if ($http_stat_type = "in") {
        return 405;
    }

    if ($http_letv = "1") {
       return 405;
    }

    proxy_set_header letv "1";

    proxy_pass http://ngx_backend$request_uri;
}

# cooperation cdn for small file 
location ~ ^/coopcdn/cloud.gslb.letv.com/.*$ {
    proxy_intercept_errors on;
    error_page 502 504 503 500 = @COOPCDN_NOT_FOUND_1;
    proxy_connect_timeout 30s;
    proxy_send_timeout    45s;
    proxy_read_timeout    45s;
    proxy_set_header User-Agent $http_user_agent;
    proxy_set_header Connection "Keep-Alive";
    proxy_set_header X-IP $remote_addr;
    proxy_set_header X-Real-IP $host;
    proxy_set_header Stat-Type in;
    set $next_host $proxy_first_ip;
    set $next_args $args;
    set $next_proxy_ip $proxy_second_ip;
    set $xrange $arg_range;

    access_by_lua_file  conf/lua/pan_secure.lua;

    if ($broadcast_proxy_ip != "") {
        set $next_host $broadcast_proxy_ip; 
        set $next_args $broadcast_proxy_args;
        set $next_proxy_ip $proxy_first_ip;
    }

    if ($next_host = "") {
        return 405;
    }

    if ($next_host ~ ([^:]*) ) {
        set $oip $1;
    }

    if ($oip = $server_addr) {
        return 404;
    }

    set $trim_args $next_args;

    if ($next_args ~* "(.*)&rstart=.*?(&.*)?$") {
        set $xrange "";
        set $trim_args $1$2;
    }

    if ($trim_args ~* "(.*)&rend=.*?(&.*)?$") {
        set $xrange "";
        set $trim_args $1$2;
    }
    proxy_set_header range $xrange;
    proxy_force_ranges on; 
    add_header Content-Disposition "attachment;filename=$arg_fname_gbk;filename*=UTF-8''$arg_fname";
    proxy_set_header Host $next_host; 
    proxy_pass http://ats_backend$uri?$trim_args;
}


location ~ ^/coopcdn/tsl1.hls.cutv.com/.*\.ts$ {
    proxy_intercept_errors on;
    error_page 502 504 503 500 = @COOPCDN_NOT_FOUND_1;
    error_page 302 = @COOPCDN_302_FOLLOW;
    error_page 405 = @COOP_GSLB;
    proxy_connect_timeout 30s;
    proxy_send_timeout    45s;
    proxy_read_timeout    45s;

    proxy_set_header User-Agent $http_user_agent;
    proxy_set_header Connection "Keep-Alive";
    proxy_set_header X-IP $remote_addr;
    proxy_set_header X-Real-IP $host;
    proxy_set_header Stat-Type in;

    set $is_gslb "0";
    if ($arg_proxy != "") {
        set $is_gslb "${is_gslb}1";
    }

    if ($is_gslb = "01") {
        return 405;
    }
    rewrite ^/coopcdn/.*?/(.*)$ /$1 break;
    proxy_set_header Host "tsl1.hls.cutv.com";
    proxy_pass http://coop.gslb.letv.com$uri?$args;
}

location ~ ^/coopcdn/(.*.juchang.tv)/.*\.m3u8 {
    error_page 405 = @COOP_GSLB;
    proxy_intercept_errors on;
    proxy_connect_timeout 30s;
    proxy_send_timeout    45s;
    proxy_read_timeout    45s;

    proxy_set_header Accept-Encoding "";
    subs_filter_types */* application/vnd.apple.mpegurl;
    subs_filter http://(.*\.ts.*$) http://$server_addr/coopcdn/$1?$args ir;

    if ($http_stat_type = "in") {
        return 405;
    }

    if ($http_letv = "1") {
       return 405;
    }

    proxy_set_header letv "1";

    proxy_pass http://ngx_backend$request_uri;

}

location ~ ^/coopcdn/(.*.alicdn.com)/.*\.m3u8 {
    proxy_intercept_errors on;
    error_page 405 = @COOP_GSLB;
    proxy_connect_timeout 30s;
    proxy_send_timeout    45s;
    proxy_read_timeout    45s;


    proxy_set_header Accept-Encoding "";
    subs_filter_types */* application/vnd.apple.mpegurl;
    subs_filter http://(.*\.ts.*$) http://$server_addr/coopcdn/$1?$args ir;


    if ($http_stat_type = "in") {
        return 405;
    }

    if ($http_letv = "1") {
       return 405;
    }

    proxy_set_header letv "1";

    proxy_pass http://ngx_backend$request_uri;
}

location ~ ^/coopcdn/d.appstore.huan.tv/.* {
    error_page 405 = @COOPCDN;
    proxy_intercept_errors on;
    proxy_connect_timeout 30s;
    proxy_send_timeout    45s;
    proxy_read_timeout    45s;

    if ($http_stat_type = "in") {
        return 405;
    }

    if ($http_letv = "1") {
       return 405;
    }

    proxy_set_header letv "1";
    proxy_pass http://ngx_backend$uri$is_args$args;
}

location ~^/coopcdn/cdn.vod.dayoo.com/.*\.m3u8 {
    proxy_intercept_errors on;
    error_page 405 = @COOP_GSLB;
    proxy_connect_timeout 30s;
    proxy_send_timeout    45s;
    proxy_read_timeout    45s;

    proxy_set_header Accept-Encoding "";
    proxy_set_header Range "";
    subs_filter_types */* application/vnd.apple.mpegurl;
    subs_filter (.*\.ts).*    $1?$args ir;

    if ($http_stat_type = "in") {
       return 405;
    }

    if ($http_letv = "1") {
       return 405;
    }

    proxy_set_header letv "1";

    proxy_pass http://ngx_backend$request_uri;
}

location ~ ^/coopcdn/(dsvideo.ott.cibntv.net)/.*\.m3u8 {
    error_page 405 = @COOP_GSLB;
    proxy_intercept_errors on;
    proxy_connect_timeout 30s;
    proxy_send_timeout    45s;
    proxy_read_timeout    45s;

    proxy_set_header Accept-Encoding "";
    proxy_set_header Range "";
    subs_filter_types */* application/vnd.apple.mpegurl;
    subs_filter http://(.*\.ts.*$) http://$server_addr/coopcdn/$1?$args ir;

    if ($http_stat_type = "in") {
        return 405;
    }

    if ($http_letv = "1") {
       return 405;
    }

    proxy_set_header letv "1";

    proxy_pass http://ngx_backend$request_uri;
}

location @COOPCDN_302_FOLLOW {
        proxy_connect_timeout 30s;
        proxy_send_timeout    45s;
        proxy_read_timeout    45s;
        proxy_set_header Stat-Type in;
        set $location_addr $upstream_http_location;
        if ($upstream_http_location = "") {
            add_header Powered-By-LetvNgx 404;
            return 404;
        }
 
        proxy_pass $location_addr;
}

location ~ ^/coopcdn/.*\.sycdn\.kuwo\.cn/resource {
    error_page 404 = @COOP_GSLB;
    rewrite ^(/coopcdn/.*\.sycdn\.kuwo\.cn/)(.*) $1$2 break;
    return 404;
}

location ~ ^/coopcdn/le.neihanbiao.com/.*-app {
    rewrite ^(.*)-app$ $1.apk last;
}

location ~ ^/coopcdn/.*\.sycdn\.kuwo\.cn {
    error_page 404 = @COOP_GSLB;
    letv_secure_link_secret    kuwo_web@1906;

    if ($secure_link_kuwo = "timeout") {
        return 410;
    }

    if ($secure_link_kuwo != "ok") {
        return 403;
    }

    if ($uri ~ ^/coopcdn/.*\.sycdn\.kuwo\.cn/(.*)$) {
        return 404;
    }

    rewrite ^(/coopcdn/.*\.sycdn\.kuwo\.cn/)\w+/\w+/(.*) $1$2 break; 
    return 404;
}

location ~ ^/coopcdn/lecdn.*audiocn.org/.*$ {
    error_page 404 = @COOP_GSLB;
    letv_secure_link_secret d228666c03c3fdfec90f831cab2693d3;
    set $sec_ok "not_ok";
    set $secure_link_v2_log $secure_link_v3;

    if ($secure_link_v2_log = "ok") {
        set $sec_ok "ok";
    }
    if ($sec_ok != "ok") {
        return 403;
    }
    return 404;
}

location ~ ^/coopcdn/ovp.upuday.com/.*$ {
    error_page 404 = @COOP_GSLB;
    letv_secure_link_secret ibrivio0m2l9ld01ltpwb;
    set $sec_ok "not_ok";
    set $secure_link_v2_log $secure_link_v3;
    
    if ($secure_link_v2_log = "ok") {
        set $sec_ok "ok";
    }
    if ($sec_ok != "ok") {
        return 403;
    }
    return 404;
}

location ~ ^/coopcdn/ovpvideo.upuday.com/.*$ {
    error_page 404 = @COOP_GSLB;
    letv_secure_link_secret ibrivio0m2l9ld01ltpwb;
    set $sec_ok "not_ok";
    set $secure_link_v2_log $secure_link_v3;

    if ($secure_link_v2_log = "ok") {
        set $sec_ok "ok";
    }
    if ($sec_ok != "ok") {
        return 403;
    }
    return 404;
}

location ~ ^/coopcdn/(.*).tvfan.cn/.*.(m3u8|flv|mp4)$ {
    error_page 404 = @COOP_GSLB;
    letv_secure_link_secret 97878050mqrfq67;
    set $sec_ok "not_ok";
    set $secure_link_v2_log $secure_link_v3;

    if ($secure_link_v2_log = "ok") {
        set $sec_ok "ok";
    }
    if ($sec_ok != "ok") {
        return 403;
    }
    return 404;
}

location ~ ^/coopcdn/m.5aikan.cn/v-mp4/.*$ {
    error_page 404 = @COOP_GSLB;
    letv_secure_link_secret XB807ae33bb02Fa5b9a5bb988942e022EB;
    set $sec_ok "not_ok";
    set $secure_link_v2_log $secure_link_v3;

    if ($secure_link_v2_log = "ok") {
        set $sec_ok "ok";
    }
    if ($sec_ok != "ok") {
        return 403;
    }
    return 404;
}

location ~ ^/coopcdn/.*yesky.com/.*$ {
    error_page 404 = @COOP_GSLB;
    letv_secure_link_secret yesky_download;
    set $sec_ok "not_ok";
    set $secure_link_v2_log $secure_link_v3;

    if ($secure_link_v2_log = "ok") {
        set $sec_ok "ok";
    }   
    if ($sec_ok != "ok") {
        return 403;
    }   
    return 404;
}


location ~ ^/coopcdn/m3u8.ltcloud.m1905.com/.*\.m3u8$ {
    error_page 405 = @COOP_GSLB;
    proxy_intercept_errors on;
    proxy_connect_timeout 30s;
    proxy_send_timeout    45s;
    proxy_read_timeout    45s;
    letv_secure_link_secret m3u8.ltcloud.m1905.com;
    more_set_headers "Content-Type: application/vnd.apple.mpegurl";
    subs_filter_types */* application/octet-stream;
    subs_filter (.*\.m3u8$) $1?m3u8x2=1 ir;
    proxy_force_ranges on;
    proxy_set_header range "";

    rewrite_by_lua '
        if ngx.var.http_letv == "1" then
            ngx.exit(405)
        end

        if ngx.var.http_stat_type == "in" then
            ngx.exit(405)
        end

        if ngx.var.secure_link_v2_log ~= "ok"  and ngx.var.arg_m3u8x2 ~= "1" then
            ngx.exit(ngx.HTTP_FORBIDDEN)
        end

    ';

    set $sec_ok "ok";
    set $secure_link_v2_log $secure_link_v3;
    proxy_set_header letv "1";

    proxy_pass http://ngx_backend$request_uri;
}

location ~ ^/coopcdn/(.*.imgo.tv)/.*\.m3u8$ {
    error_page 405 = @COOP_GSLB;
    proxy_intercept_errors on;
    proxy_connect_timeout 30s;
    proxy_send_timeout    45s;
    proxy_read_timeout    45s;
    proxy_force_ranges on;
    proxy_set_header range "";
    set $user_host $1;

    set $dst_args "path=$arg_path&proxy=$arg_proxy&lersrc=$arg_lersrc&tag=$arg_tag&platid=$arg_platid&sign=$arg_sign";
    subs_filter_types */* application/vnd.apple.mpegurl;
    subs_filter (.*\.ts$) /coopcdn/$user_host/$1?$dst_args ir;

    if ($http_stat_type = "in") {
        return 405;
    }

    if ($http_letv = "1") {
       return 405;
    }

    proxy_set_header letv "1";

    proxy_pass http://ngx_backend$request_uri;
}


location ~ ^/coopcdn/(.*.ufile.ucloud.com.cn)/.*\.m3u8$ {
    error_page 405 = @COOP_GSLB;
    proxy_intercept_errors on;
    proxy_connect_timeout 30s;
    proxy_send_timeout    45s;
    proxy_read_timeout    45s;
    proxy_force_ranges on;
    proxy_set_header range "";
    set $user_host $1;

    set $dst_args "path=$arg_path&proxy=$arg_proxy&lersrc=$arg_lersrc&tag=$arg_tag&platid=$arg_platid&sign=$arg_sign&sthost=$arg_sthost";
    subs_filter_types */* application/vnd.apple.mpegurl application/octet-stream;
    subs_filter (.*\.ts$) http://$server_addr/coopcdn/$user_host/$1?$dst_args ir;

    if ($http_stat_type = "in") {
        return 405;
    }

    if ($http_letv = "1") {
       return 405;
    }

    proxy_set_header letv "1";

    proxy_pass http://ngx_backend$request_uri;
}


location @COOP_GSLB {
    proxy_intercept_errors on;
    error_page 502 504 503 500 = @COOPCDN_NOT_FOUND_1;
    proxy_connect_timeout 30s;
    proxy_send_timeout    45s;
    proxy_read_timeout    45s;
    proxy_set_header User-Agent $http_user_agent;
    proxy_set_header Connection "Keep-Alive";
    proxy_set_header X-IP $remote_addr;
    proxy_set_header X-Real-IP $host;
    proxy_set_header Stat-Type in;

    set $next_host $proxy_first_ip;
    set $next_args $args;
    set $next_proxy_ip $proxy_second_ip;

    if ($broadcast_proxy_ip != "") {
        set $next_host $broadcast_proxy_ip;
        set $next_args $broadcast_proxy_args;
        set $next_proxy_ip $proxy_first_ip;
    }

    if ($next_host = "") {
        return 405;
    }
    
    if ($next_host ~ ([^:]*) ) {
        set $oip $1;
    }
   
    if ($oip = $server_addr) {
        return 404;
    }

    set $trim_args $next_args;

    if ($next_args ~* "(.*)&rstart=.*?(&.*)?$") {
        set $trim_args $1$2;
    }

    if ($trim_args ~* "(.*)&rend=.*?(&.*)?$") {
        set $trim_args $1$2;
    }

    set $origin_path "origin_path=${arg_path}&";
    if ($arg_origin_path) {
        set $origin_path "";
    }

    proxy_force_ranges on;
    proxy_set_header Range "";
    proxy_set_header Host $next_host;
    proxy_pass http://ats_backend$uri?$origin_path$trim_args;
}

location ~ ^/coopcdn/mvvideo\d.meitudata.com/.* {
    proxy_intercept_errors on;
    error_page 401 = @COOPCDN_MEIPAI;
    proxy_connect_timeout 30s;
    proxy_send_timeout    45s;
    proxy_read_timeout    45s;
    proxy_set_header last 1;
    proxy_set_header X-IP $remote_addr;
    proxy_set_header X-Real-IP $host;
    proxy_set_header Stat-Type in;

    if ($http_last = 1) {
        return 401;
    }

    proxy_pass http://ngx_backend;
}

location @COOPCDN_MEIPAI {
    proxy_intercept_errors on;
    error_page 502 504 503 500 = @COOPCDN_NOT_FOUND_1;
    proxy_connect_timeout 30s;
    proxy_send_timeout    45s;
    proxy_read_timeout    45s;
    proxy_set_header User-Agent $http_user_agent;
    proxy_set_header Connection "Keep-Alive";
    proxy_http_version  1.1;

    set $next_host $proxy_first_ip;
    set $next_args $args;
    set $next_proxy_ip $proxy_second_ip;
    set $xrange "";

    if ($broadcast_proxy_ip != "") {
        set $next_host $broadcast_proxy_ip;
        set $next_args $broadcast_proxy_args;
        set $next_proxy_ip $proxy_first_ip;
    }

    if ($next_host = "") {
        return 405;
    }
    if ($next_host ~ ([^:]*) ) {
        set $oip $1;
    }
    if ($oip = $server_addr) {
        return 404;
    }

    set $trim_args $next_args;

    if ($next_args ~* "(.*)&rstart=.*?(&.*)?$") {
        set $trim_args $1$2;
    }

    if ($trim_args ~* "(.*)&rend=.*?(&.*)?$") {
        set $trim_args $1$2;
    }

    set $origin_path "origin_path=${arg_path}&";
    if ($arg_origin_path) {
        set $origin_path "";
    }

    set $xrange $http_range;
    set $xuri   $uri;
    set $xnext_host $next_host;
    set $xorigin_path $origin_path;
    set $xtrim_args $trim_args;

    if ($uri ~* "neihanbiao.com/.*/(.*)") {
        add_header Content-Disposition "filename=$1";
    }

    proxy_force_ranges on;
    proxy_set_header Range $xrange;
    proxy_set_header Host $next_host;
    proxy_pass http://ats_backend$uri?$trim_args&$origin_path;
    post_action /nice_postaction;
}

location ~ ^/coopcdn/(le2|flac).zhenxian.fm/.*\.flac {
    proxy_intercept_errors on;
    error_page 401 = @COOPCDN;
    proxy_connect_timeout 30s; 
    proxy_send_timeout    45s; 
    proxy_read_timeout    45s; 
    proxy_set_header last 1;
    proxy_set_header X-IP $remote_addr;
    proxy_set_header X-Real-IP $host;
    proxy_set_header Stat-Type in;

    if ($http_last = 1) { 
        return 401; 
    }    

    more_set_headers "Content-Type: audio/flac";
    proxy_pass http://ngx_backend;
}

location ~ ^/coopcdn/.*m.ubeibei.cn/ {
    proxy_intercept_errors on;
    error_page 401 = @COOPCDN;
    proxy_connect_timeout 30s; 
    proxy_send_timeout    45s; 
    proxy_read_timeout    45s; 
    proxy_set_header last 1;
    proxy_set_header X-IP $remote_addr;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header Stat-Type in;

    if ($http_last = 1) { 
        return 401; 
    }    

    proxy_pass http://ngx_backend;
}

location ~ ^/coopcdn/update.cedock.com/ {
    proxy_intercept_errors on;
    proxy_connect_timeout 30s; 
    proxy_send_timeout    45s; 
    proxy_read_timeout    45s; 
    proxy_set_header X-IP $remote_addr;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header Stat-Type in;

    slice 4m;
    proxy_redirect off;
    proxy_set_header Range $slice_range;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_set_header Client-ip       $remote_addr;
    proxy_set_header X-Forwarded-For  $proxy_add_x_forwarded_for;
    proxy_set_header Store-Partition "1";

    set $next_host $proxy_first_ip;
    set $next_args $args;

    if ($broadcast_proxy_ip != "") {
        set $next_host $broadcast_proxy_ip;
        set $next_args $broadcast_proxy_args;
    }

    if ($next_host = "") {
        return 405;
    }
    if ($next_host ~ ([^:]*) ) {
        set $oip $1;
    }
    if ($oip = $server_addr) {
        return 404;
    }

    set $trim_args $next_args;

    if ($next_args ~* "(.*)&rstart=.*?(&.*)?$") {
        set $trim_args $1$2;
    }

    if ($trim_args ~* "(.*)&rend=.*?(&.*)?$") {
        set $trim_args $1$2;
    }

    set $origin_path "origin_path=${arg_path}&";
    if ($arg_origin_path) {
        set $origin_path "";
    }
    if ($request_uri ~ ([^?]*)) {
        set $xuri $1;
    }

    proxy_set_header Host $next_host;
    proxy_pass http://ats_backend$xuri/storepartition?$trim_args&$origin_path;
}

location ~ ^/coopcdn/.*coolyun.com/ {
    proxy_intercept_errors on;
    error_page 401 = @COOPCDN_COOLYUN;
    proxy_connect_timeout 30s; 
    proxy_send_timeout    45s; 
    proxy_read_timeout    45s; 
    proxy_set_header last 1;
    proxy_set_header X-IP $remote_addr;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header Stat-Type in;

    if ($http_last = 1) { 
        return 401; 
    }    

    proxy_pass http://ngx_backend; 
}

location ~ ^/coopcdn/ {
    proxy_intercept_errors on;
    error_page 401 = @COOPCDN;
    proxy_connect_timeout 30s;
    proxy_send_timeout    45s;
    proxy_read_timeout    45s;
    proxy_set_header last 1;
    proxy_set_header X-IP $remote_addr;
    proxy_set_header X-Real-IP $host;
    proxy_set_header Stat-Type in;

    if ($http_last = 1) {
        return 401;
    }

    proxy_pass http://ngx_backend;
}

location @COOPCDN_COOLYUN {
    proxy_intercept_errors on;
    error_page 502 504 503 500 = @COOPCDN_NOT_FOUND_1;
    proxy_connect_timeout 30s;
    proxy_send_timeout    45s;
    proxy_read_timeout    45s;
    proxy_set_header User-Agent $http_user_agent;
    proxy_set_header Connection "Keep-Alive";
    proxy_http_version  1.1;

    set $next_host $proxy_first_ip;
    set $next_args $args;
    set $next_proxy_ip $proxy_second_ip;
    set $xrange "";

    if ($broadcast_proxy_ip != "") {
        set $next_host $broadcast_proxy_ip;
        set $next_args $broadcast_proxy_args;
        set $next_proxy_ip $proxy_first_ip;
    }

    if ($next_host = "") {
        return 405;
    }
    if ($next_host ~ ([^:]*) ) {
        set $oip $1;
    }
    if ($oip = $server_addr) {
        return 404;
    }

    set $trim_args $next_args;

    if ($next_args ~* "(.*)&rstart=.*?(&.*)?$") {
        set $trim_args $1$2;
    }

    if ($trim_args ~* "(.*)&rend=.*?(&.*)?$") {
        set $trim_args $1$2;
    }

    set $origin_path "origin_path=${arg_path}&";
    if ($arg_origin_path) {
        set $origin_path "";
    }
 
    set $xrange $http_range;
    if ($request_uri ~ ([^?]*)) {
        set $xuri $1;
    }
    #set $xuri   $uri;
    set $xnext_host $next_host;
    set $xorigin_path $origin_path;
    set $xtrim_args $trim_args;

    if ($uri ~* "neihanbiao.com/.*/(.*)") {
        add_header Content-Disposition "filename=$1";
    }

    proxy_force_ranges on;
    proxy_set_header Range $xrange;
    proxy_set_header Host $next_host;
    #proxy_pass http://ats_backend$request_uri;
    proxy_pass http://ats_backend$xuri?$trim_args&$origin_path;
    post_action /nice_postaction;
}

location @COOPCDN {
    proxy_intercept_errors on;
    error_page 502 504 503 500 = @COOPCDN_NOT_FOUND_1;
    proxy_connect_timeout 30s;
    proxy_send_timeout    45s;
    proxy_read_timeout    45s;
    proxy_set_header User-Agent $http_user_agent;
    proxy_set_header Connection "Keep-Alive";
    proxy_http_version  1.1;

    set $next_host $proxy_first_ip;
    set $next_args $args;
    set $next_proxy_ip $proxy_second_ip;
    set $xrange "";

    if ($broadcast_proxy_ip != "") {
        set $next_host $broadcast_proxy_ip;
        set $next_args $broadcast_proxy_args;
        set $next_proxy_ip $proxy_first_ip;
    }

    if ($next_host = "") {
        return 405;
    }
    if ($next_host ~ ([^:]*) ) {
        set $oip $1;
    }
    if ($oip = $server_addr) {
        return 404;
    }

    set $trim_args $next_args;

    if ($next_args ~* "(.*)&rstart=.*?(&.*)?$") {
        set $trim_args $1$2;
    }

    if ($trim_args ~* "(.*)&rend=.*?(&.*)?$") {
        set $trim_args $1$2;
    }

    set $origin_path "origin_path=${arg_path}&";
    if ($arg_origin_path) {
        set $origin_path "";
    }
 
    set $xrange $http_range;
    set $xuri   $uri;
    set $xnext_host $next_host;
    set $xorigin_path $origin_path;
    set $xtrim_args $trim_args;

    if ($uri ~* "neihanbiao.com/.*/(.*)") {
        add_header Content-Disposition "filename=$1";
    }

    proxy_force_ranges on;
    proxy_set_header Range $xrange;
    proxy_set_header Host $next_host;
    proxy_pass http://ats_backend$uri?$origin_path$trim_args;
    post_action /nice_postaction;
}

location = /nice_postaction {
    proxy_intercept_errors on;
    error_page 502 504 503 500 = @COOPCDN_NOT_FOUND_1;
    proxy_connect_timeout 30s;
    proxy_send_timeout    45s;
    proxy_read_timeout    45s;
    proxy_set_header User-Agent $http_user_agent;
    proxy_set_header Connection "Keep-Alive";
    set $re "0";

    if ($xrange = "") {
        return 200;
    }
 
    proxy_force_ranges on;
    proxy_set_header Range "";
    proxy_set_header Host $xnext_host;
    proxy_pass http://ats_backend$xuri?$xorigin_path$xtrim_args;
}

location @COOPCDN_NOT_FOUND_1 {
    proxy_intercept_errors on;
    error_page 502 504 503 500 = @COOPCDN_NOT_FOUND_2;
    proxy_set_header X-Real-IP $host;
    proxy_set_header X-IP $remote_addr;
    proxy_set_header User-Agent owninneragent;
    proxy_set_header Connection "Keep-Alive";
    proxy_set_header Stat-Type in;
    proxy_connect_timeout 30s;
    proxy_send_timeout    45s;
    proxy_read_timeout    45s;

    if ($next_proxy_ip = "") {
        return 405;
    }

    if ($next_proxy_ip ~ ([^:]*) ) {
        set $oip $1;
    }

    if ($oip = $server_addr) {
        return 404;
    }
    
    proxy_force_ranges on; 
    proxy_set_header Range "";
    proxy_set_header Host $next_proxy_ip; 
    proxy_pass http://ats_backend$uri?$args;    
}

location @COOPCDN_NOT_FOUND_2 {
    proxy_set_header X-Real-IP $host;
    proxy_set_header X-IP $remote_addr;
    proxy_set_header User-Agent owninneragent;
    proxy_set_header Connection "Keep-Alive";
    proxy_set_header Stat-Type in;
    proxy_connect_timeout 30s;
    proxy_send_timeout    45s;
    proxy_read_timeout    45s;

    if ($next_proxy_ip = $proxy_second_ip) {
        return 405; 
    }

    if ($proxy_second_ip = "") {
        return 405;
    }
    
    if ($proxy_second_ip ~ ([^:]*) ) {
        set $oip $1;
    }

    if ($oip = $server_addr) {
        return 404;
    }

    
    proxy_force_ranges on; 
    proxy_set_header Range "";
    proxy_set_header Host $proxy_second_ip; 
    proxy_pass http://ats_backend$uri?$args;
}

# ats version interface
location = /ats_version_md5 {
    root /usr/local/etc/ats/;
}

#####################################
#    cache purge entrance 
#####################################

# coopbig purge
location ~ ^/cache_purge/.*?/coopbig/ {
    proxy_connect_timeout 30s;
    proxy_send_timeout    30s;
    proxy_read_timeout    30s;
    
    if ($request_method = "GET") {
        rewrite ^/cache_purge/.*?/coopbig/(.*) $1 break;
    }
    proxy_pass http://127.0.0.1:10123/api/purge?file=coopbig/$uri;
}

# coopcdn purge
location ~ ^/cache_purge/dir/coopcdn/ {
    proxy_connect_timeout 30s;
    proxy_send_timeout    30s;
    proxy_read_timeout    30s;
    proxy_set_header Host "127.0.0.1:18980";

    #rewrite ^/cache_purge/dir(/coopcdn/.*) /cm/$1 break;
    proxy_pass http://127.0.0.1:18980$uri?$args;
}

location ~ ^/cache_purge/file/(coopcdn/.*) {
    proxy_connect_timeout 30s;
    proxy_send_timeout    30s;
    proxy_read_timeout    30s;
    set $lhost "127.0.0.1";
    proxy_set_header Host $lhost;
    proxy_pass http://127.0.0.1:18980/$1?proxy=1;
}
